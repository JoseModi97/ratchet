<!DOCTYPE html>
<html>
<head>
    <title>Chat App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; display: flex; flex-direction: column; height: 100vh; font-size: 14px; }
        .container { width: 100%; background-color: #fff; display: flex; flex-direction: column; flex-grow: 1; /* Removed max-width, margin, border-radius, box-shadow */}

        .header-bar { background-color: #007bff; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; /* Removed border-top-left-radius, border-top-right-radius */ }
        .header-bar #user-info { font-weight: bold; }
        .header-bar #logout-button { background-color: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .header-bar #logout-button:hover { background-color: #c82333; }

        /* Auth Forms */
        #auth-container { padding: 30px; }
        #auth-container h2 { text-align: center; margin-bottom: 20px; color: #333; }
        .auth-form { display: none; }
        .auth-form input[type="text"], .auth-form input[type="password"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .auth-form button[type="submit"] { width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .auth-form button[type="submit"]:hover { background-color: #0056b3; }
        .toggle-form { text-align: center; margin-top: 15px; }
        .toggle-form button { background: none; border: none; color: #007bff; cursor: pointer; text-decoration: underline; font-size: 0.9em; }
        #auth-message { text-align: center; margin-bottom: 15px; color: red; min-height: 1.2em; }

        /* Room Dashboard */
        #room-dashboard { padding: 20px; display: none; }
        #room-dashboard h2 { margin-top: 0; color: #333; text-align: center; }
        #room-dashboard h3 { margin-top: 20px; margin-bottom: 10px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        #create-room-form input[type="text"] { width: calc(70% - 12px); padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px;}
        #create-room-form button { padding: 8px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #create-room-form button:hover { background-color: #218838; }
        #room-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
        #room-list li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        #room-list li:last-child { border-bottom: none; }
        #room-list li:hover { background-color: #f0f0f0; }
        #room-list .room-creator { font-size: 0.8em; color: #777; }
        #dashboard-message { text-align: center; margin-top: 10px; color: #555; }


        /* Chat Area */
        #chat-wrapper { display: none; flex-grow: 1; flex-direction: column; }
        #chat-header { background-color: #6c757d; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        #chat-header #current-room-display { font-weight: bold; }
        #chat-header #back-to-dashboard { background-color: #ffc107; color: #212529; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        #chat-header #back-to-dashboard:hover { background-color: #e0a800; }

        /* Notification Button & Popup Styles */
        #notification-button { background-color: transparent; color: white; border: none; font-size: 1.2em; cursor: pointer; padding: 5px; position: relative; }
        #notification-button:hover { opacity: 0.8; }
        #notification-counter { position: absolute; top: -2px; right: -4px; background-color: red; color: white; border-radius: 50%; padding: 1px 4px; font-size: 0.65em; line-height: 1; display: none; /* Initially hidden */ }
        #notification-popup {
            display: none; /* Initially hidden */
            position: absolute; /* Relative to chat-container */
            top: 10px; /* Small padding from the top of chat-container */
            right: 10px; /* Small padding from the right of chat-container */
            width: calc(100% - 40px); /* Adjust width, consider padding of parent */
            max-width: 300px; /* Max width for readability */
            max-height: calc(100% - 60px); /* Adjust based on chat-container height and input area, leave space for input area */
            overflow-y: auto;
            background-color: #f9f9f9; /* Slightly different background to distinguish */
            border: 1px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10; /* Above chat messages but below overall modals if any */
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        #notification-popup h4 { margin-top: 0; margin-bottom: 10px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        #notification-list { list-style-type: decimal; /* Numbered list */ padding-left: 20px; /* Space for numbers */ margin: 0; }
        #notification-list li { padding: 6px 0; border-bottom: 1px solid #f0f0f0; color: #555; }
        #notification-list li:last-child { border-bottom: none; }
        .notification-timestamp { font-size: 0.8em; color: #888; margin-left: 8px; }


        #chat-content-wrapper { display: flex; flex-grow: 1; overflow: hidden; }

        #chat-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; /* For load more button */ }
        #load-more-messages { display: none; /* Hidden by default */ width: auto; margin: 10px auto 0px auto; padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; text-align: center;}
        #load-more-messages:hover { background-color: #5a6268; }

        #chat-output { /* height: 300px; Adjusted for member list */ overflow-y: auto; padding: 15px; border-bottom: 1px solid #eee; flex-grow: 1;}
        .message { margin-bottom: 12px; line-height: 1.4; }
        .message .sender { font-weight: bold; color: #007bff; }
        .message .text { margin-left: 8px; color: #333; word-wrap: break-word; }
        .server-message { font-style: italic; color: #6c757d; text-align: center; margin-bottom: 10px; font-size: 0.9em;}
        #input-area { display: flex; padding: 15px; border-top: 1px solid #eee; background-color: #f8f9fa; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; }
        #send-button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #send-button:hover { background-color: #0056b3; }
        #status { padding: 8px 15px; background-color: #e9ecef; text-align: center; font-size: 0.85em; color: #495057; border-bottom: 1px solid #ddd;}

        /* Member List & Invite Area */
        #member-invite-area { width: 200px; border-left: 1px solid #ddd; padding: 15px; background-color: #f8f9fa; display: flex; flex-direction: column; }
        #member-invite-area h4 { margin-top: 0; margin-bottom: 10px; font-size: 1.1em; color: #333; }
        #member-list { list-style: none; padding: 0; margin-bottom: 15px; max-height: 150px; overflow-y: auto; }
        #member-list li { padding: 5px 0; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        #member-list .remove-member-btn { background: none; border: none; color: #dc3545; cursor: pointer; font-size: 0.8em; padding: 2px 5px;}
        #member-list .remove-member-btn:hover { text-decoration: underline; }

        /* #invite-form input[type="text"] { width: calc(100% - 18px); padding: 6px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.9em;} */ /* Replaced by select */
        #invite-form select#invite-user-select { /* Style already applied inline, but can be centralized here */ }
        #invite-form button { width: 100%; padding: 6px; background-color: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.9em;}
        #invite-form button:hover { background-color: #138496; }
        #member-invite-message { font-size: 0.8em; color: green; margin-top: 5px; min-height: 1em;}


        /* Styles from white_chat.html */
        .chat-online {
            color: #34ce57
        }

        .chat-offline {
            color: #e4606d
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            max-height: 800px; /* Consider adjusting this based on overall layout */
            overflow-y: scroll
        }

        .chat-message-left,
        .chat-message-right {
            display: flex;
            flex-shrink: 0
        }

        .chat-message-left {
            margin-right: auto
        }

        .chat-message-right {
            flex-direction: row-reverse;
            margin-left: auto
        }
        /* Bootstrap utility classes from white_chat.html - may be redundant but included for fidelity */
        /*
        .py-3 {
            padding-top: 1rem!important;
            padding-bottom: 1rem!important;
        }
        .px-4 {
            padding-right: 1.5rem!important;
            padding-left: 1.5rem!important;
        }
        .flex-grow-0 {
            flex-grow: 0!important;
        }
        .border-top {
            border-top: 1px solid #dee2e6!important;
        }
        */
        /* End Styles from white_chat.html */


        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            body { font-size: 13px; } /* Slightly smaller base font */

            .header-bar, #chat-header, #input-area { padding: 10px; }
            #auth-container, #room-dashboard { padding: 15px; }

            #room-dashboard h2 { font-size: 1.5em; }
            #room-dashboard h3 { font-size: 1.1em; }
            #create-room-form input[type="text"] { width: calc(100% - 90px); /* Adjust based on button width */ }
            #room-list li { padding: 8px; }


            #chat-content-wrapper { flex-direction: column; }
            #member-invite-area {
                width: 100%; /* Take full width */
                border-left: none; /* Remove left border */
                border-top: 1px solid #ddd; /* Add top border */
                max-height: 250px; /* Limit height when stacked */
                overflow-y: auto;
            }
            #member-invite-area h4 { font-size: 1em; margin-bottom: 8px; }
            #member-list { max-height: 120px; /* Adjust height for stacked view */ }
            #invite-form select#invite-user-select, #invite-form button { font-size: 0.85em; padding: 8px; }


            #chat-output { padding: 10px; }
            .message .sender { font-size: 0.95em; }
            .message .text { font-size: 0.9em; }

            #message-input { padding: 8px; margin-right: 8px; }
            #send-button, #back-to-dashboard, .header-bar #logout-button { padding: 8px 12px; font-size: 0.9em; }

            /* Auth forms adjustments */
            .auth-form input[type="text"], .auth-form input[type="password"] { padding: 12px; }
            .auth-form button[type="submit"] { padding: 12px; font-size: 1em; }

            /* Notification popup adjustments for smaller screens */
            #notification-popup {
                top: 5px;
                right: 5px;
                width: calc(100% - 10px); /* More screen width */
                max-height: calc(100% - 50px); /* Adjust max height */
                font-size: 0.85em;
            }
             #notification-button { font-size: 1.1em; }
        }

        @media (max-width: 480px) {
            body { font-size: 12px; }
            .header-bar, #chat-header, #input-area { padding: 8px; }
            #auth-container, #room-dashboard { padding: 10px; }

            #create-room-form input[type="text"] { width: calc(100% - 80px); } /* Further adjust */
            #create-room-form button { padding: 8px 10px; }


            #chat-header #current-room-display { font-size: 0.9em; }
            #back-to-dashboard { font-size: 0.8em; padding: 6px 8px; }
            .header-bar #logout-button { font-size: 0.8em; padding: 6px 8px; }


            #send-button { padding: 8px 15px; }

            /* Make member/invite area more compact if it's visible */
            #member-invite-area { max-height: 200px; }
            #member-list { max-height: 100px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-bar" style="display: none;" id="main-header-bar">
            <span id="user-info"></span>
            <button id="logout-button">Logout</button>
        </div>

        <!-- Authentication Forms -->
        <div id="auth-container">
            <h2 id="auth-title">Login</h2>
            <div id="auth-message"></div>
            <form id="login-form" class="auth-form">
                <input type="text" id="login-username" placeholder="Username" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit">Login</button>
                <div class="toggle-form">
                    Don't have an account? <button type="button" id="show-register">Register here</button>
                </div>
            </form>
            <form id="register-form" class="auth-form">
                <input type="text" id="register-username" placeholder="Username" required>
                <input type="password" id="register-password" placeholder="Password" required>
                <button type="submit">Register</button>
                <div class="toggle-form">
                    Already have an account? <button type="button" id="show-login">Login here</button>
                </div>
            </form>
        </div>

        <!-- Room Dashboard -->
        <div id="room-dashboard">
            <h2>Room Dashboard</h2>
            <div id="dashboard-message"></div>
            <form id="create-room-form">
                <h3>Create New Room</h3>
                <input type="text" id="new-room-name" placeholder="Enter room name" required>
                <button type="submit">Create Room</button>
            </form>
            <h3>Your Rooms</h3>
            <ul id="room-list">
                <!-- Room items will be populated by JS -->
            </ul>
        </div>

        <!-- Chat Application -->
        <div id="chat-wrapper">
            <div id="chat-header">
                <span id="current-room-display"></span>
                <div>
                    <button id="notification-button" style="position: relative; margin-right: 10px;">
                        &#128276; <!-- Bell icon -->
                        <span id="notification-counter" style="position: absolute; top: -5px; right: -5px; background-color: red; color: white; border-radius: 50%; padding: 2px 5px; font-size: 0.7em; display: none;">0</span>
                    </button>
                    <button id="back-to-dashboard">Back to Rooms</button>
                </div>
            </div>
            <div id="status">Connecting...</div>
            <div id="chat-content-wrapper">
                <div id="chat-container">
                    <div id="notification-popup" style="display: none; /* Initial style, will be refined by CSS block */">
                        <h4>Room Activity</h4>
                        <ul id="notification-list" style="list-style-type: none; padding: 0; margin: 0;">
                            <!-- Notifications will be added here by JS -->
                        </ul>
                    </div>
                    <button id="load-more-messages">Load More Messages</button>
                    <div id="chat-output" class="chat-messages p-4">
                        <!-- Messages will be dynamically added here by JavaScript -->
                    </div>
                    <div id="input-area" class="flex-grow-0 py-3 px-4 border-top">
                        <div class="input-group">
                            <input type="text" id="message-input" class="form-control" placeholder="Type your message...">
                            <button id="send-button" class="btn btn-primary">Send</button>
                        </div>
                    </div>
                </div>
                <div id="member-invite-area" style="display: none;"> <!-- Initially hidden, shown if creator -->
                    <h4>Members</h4>
                    <ul id="member-list"></ul>
                    <div id="member-invite-message"></div>
                    <form id="invite-form">
                        <h4>Invite User</h4>
                        <select id="invite-user-select" required style="width: 100%; padding: 6px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.9em; background-color: white;">
                            <option value="">Select user to invite...</option>
                        </select>
                        <button type="submit">Invite</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // UI Elements - Auth
            const authContainer = document.getElementById('auth-container');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const authMessage = document.getElementById('auth-message');
            const authTitle = document.getElementById('auth-title');
            const showRegisterBtn = document.getElementById('show-register');
            const showLoginBtn = document.getElementById('show-login');

            // UI Elements - Main Header
            const mainHeaderBar = document.getElementById('main-header-bar');
            const userInfoDisplay = document.getElementById('user-info');
            const logoutButton = document.getElementById('logout-button');

            // UI Elements - Room Dashboard
            const roomDashboard = document.getElementById('room-dashboard');
            const createRoomForm = document.getElementById('create-room-form');
            const newRoomNameInput = document.getElementById('new-room-name');
            const roomListUL = document.getElementById('room-list');
            const dashboardMessage = document.getElementById('dashboard-message');

            // UI Elements - Chat
            const chatWrapper = document.getElementById('chat-wrapper');
            const chatHeader = document.getElementById('chat-header');
            const currentRoomDisplay = document.getElementById('current-room-display');
            const backToDashboardButton = document.getElementById('back-to-dashboard');
            const statusDisplay = document.getElementById('status');
            const chatOutput = document.getElementById('chat-output'); // This is the scrollable message area
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const loadMoreMessagesButton = document.getElementById('load-more-messages');

            // UI Elements - Notifications
            const notificationButton = document.getElementById('notification-button');
            const notificationCounter = document.getElementById('notification-counter');
            const notificationPopup = document.getElementById('notification-popup');
            const notificationListUL = document.getElementById('notification-list');


            // UI Elements - Member/Invite Area
            const memberInviteArea = document.getElementById('member-invite-area');
            const memberListUL = document.getElementById('member-list');
            const inviteForm = document.getElementById('invite-form');
            const inviteUserSelect = document.getElementById('invite-user-select'); // Changed from inviteUsernameInput
            const memberInviteMessage = document.getElementById('member-invite-message');


            let socket = null;
            let currentUsername = null;
            let currentUserId = null;
            let currentRoomId = null;
            let currentRoomCreatorId = null;
            let oldestMessageIdLoaded = null; // Track the oldest message ID loaded for pagination
            let isLoadingHistory = false; // Flag to prevent multiple history loads

            // Notification state
            let notifications = [];
            let unreadNotificationCount = 0;

            function escapeHtml(unsafe) {
                return unsafe
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
            }

            function addMessageToChat(data, isHistory = false) {
                // data expected for history: { id, senderUsername, content, messageType, sentAt, userId (sender's ID) }
                // data expected for live WebSocket: { type: 'message'/'server_message'/'error', sender: '...', text: '...' }

                // Provide defaults to prevent undefined being passed to escapeHtml
                let SENDER_TEXT = data.senderUsername || data.sender || "System";
                let CONTENT_TEXT = typeof data.content !== 'undefined' ? data.content : (typeof data.text !== 'undefined' ? data.text : "");
                let MESSAGE_TYPE = data.messageType || data.type; // 'user', 'system_join', 'system_leave', 'server_message', 'error'
                let SENT_AT = data.sentAt || new Date().toISOString();

                const isMe = SENDER_TEXT === currentUsername;

                // --- Notification Filtering for join/leave messages ---
                const isJoinLeaveMessage = (MESSAGE_TYPE === 'system_join' || MESSAGE_TYPE === 'system_leave') ||
                                           (MESSAGE_TYPE === 'server_message' && (CONTENT_TEXT.includes(' has joined the room') || CONTENT_TEXT.includes(' has left the room')));

                if (isJoinLeaveMessage) {
                    let notificationText = CONTENT_TEXT;
                    if (MESSAGE_TYPE === 'system_join' || MESSAGE_TYPE === 'system_leave') {
                        try { // system_join/leave content is JSON: {"text": "User X has joined/left..."}
                            const parsedContent = JSON.parse(CONTENT_TEXT);
                            notificationText = parsedContent.text || CONTENT_TEXT;
                        } catch (e) { /* Fallback to CONTENT_TEXT if not JSON */ }
                    }
                    addNotification(escapeHtml(notificationText), SENT_AT);
                    return; // Do not display join/leave messages in the main chat
                }

                // Filter out "WebSocket connected..." messages entirely
                const isWebSocketConnectMessage = MESSAGE_TYPE === 'server_message' && CONTENT_TEXT.startsWith('WebSocket connected to room');
                if (isWebSocketConnectMessage) {
                    console.log("Filtered out WebSocket connect message:", CONTENT_TEXT);
                    return;
                }

                // --- Create message element based on new structure ---
                const messageWrapperDiv = document.createElement('div');
                if (data.id) {
                    messageWrapperDiv.dataset.messageId = data.id;
                }

                if (MESSAGE_TYPE === 'server_message' || MESSAGE_TYPE === 'error') {
                    // Server messages or errors - display differently, not as chat bubbles
                    messageWrapperDiv.classList.add('server-message', 'text-muted', 'small', 'text-center', 'my-2');
                    messageWrapperDiv.textContent = escapeHtml(CONTENT_TEXT);
                } else {
                    // Regular user messages - apply new chat bubble styling
                    messageWrapperDiv.classList.add(isMe ? 'chat-message-right' : 'chat-message-left', 'pb-4');

                    // Inner div for styling the bubble itself
                    const messageBubbleDiv = document.createElement('div');
                    messageBubbleDiv.classList.add('flex-shrink-1', 'bg-light', 'rounded', 'py-2', 'px-3');
                    messageBubbleDiv.classList.add(isMe ? 'mr-3' : 'ml-3');

                    const senderNameDiv = document.createElement('div');
                    senderNameDiv.classList.add('font-weight-bold', 'mb-1');
                    senderNameDiv.textContent = escapeHtml(SENDER_TEXT) + (isMe ? "" : ""); // " (Me)" part is removed as alignment indicates self

                    const messageTextNode = document.createTextNode(escapeHtml(CONTENT_TEXT));

                    messageBubbleDiv.appendChild(senderNameDiv);
                    messageBubbleDiv.appendChild(messageTextNode);

                    // Avatar/timestamp placeholder div (as in white_chat.html)
                    const avatarPlaceholderDiv = document.createElement('div');
                    // In future, avatar img and timestamp could go here
                    // For now, it's an empty div to maintain structure if needed by flex properties.

                    messageWrapperDiv.appendChild(avatarPlaceholderDiv); // Empty div for structure from template
                    messageWrapperDiv.appendChild(messageBubbleDiv);
                }

                if (isHistory) {
                    chatOutput.insertBefore(messageWrapperDiv, chatOutput.firstChild); // Prepend for history
                } else {
                    chatOutput.appendChild(messageWrapperDiv); // Append for live messages
                    chatOutput.scrollTop = chatOutput.scrollHeight; // Auto-scroll for new messages
                }
            }

            function setDashboardMessage(message, isError = false) {
                dashboardMessage.textContent = message;
                dashboardMessage.style.color = isError ? 'red' : 'green';
                setTimeout(() => dashboardMessage.textContent = '', 3000);
            }

            function setMemberInviteMessage(message, isError = false) {
                memberInviteMessage.textContent = message;
                memberInviteMessage.style.color = isError ? 'red' : 'green';
                setTimeout(() => memberInviteMessage.textContent = '', 3000);
            }

            // --- Notification Logic ---
            function renderNotifications() {
                notificationListUL.innerHTML = ''; // Clear existing notifications
                notifications.forEach(notif => {
                    const li = document.createElement('li');
                    li.textContent = notif.text;
                    // Optionally add timestamp if available in notif object
                    // if (notif.timestamp) {
                    //     const timeSpan = document.createElement('span');
                    //     timeSpan.className = 'notification-timestamp';
                    //     timeSpan.textContent = new Date(notif.timestamp).toLocaleTimeString();
                    //     li.appendChild(timeSpan);
                    // }
                    notificationListUL.appendChild(li);
                });

                if (unreadNotificationCount > 0) {
                    notificationCounter.textContent = unreadNotificationCount;
                    notificationCounter.style.display = 'block';
                } else {
                    notificationCounter.style.display = 'none';
                }
            }

            function addNotification(messageText, messageTimestamp) {
                // Limit the number of stored notifications to, say, 50
                if (notifications.length >= 50) {
                    notifications.shift(); // Remove the oldest
                }
                notifications.push({ text: messageText, timestamp: messageTimestamp });
                unreadNotificationCount++;
                renderNotifications();
            }

            notificationButton.addEventListener('click', () => {
                if (parseInt(currentUserId) === parseInt(currentRoomCreatorId)) {
                    notificationPopup.style.display = notificationPopup.style.display === 'none' ? 'block' : 'none';
                    if (notificationPopup.style.display === 'block') {
                        unreadNotificationCount = 0; // Clear counter when popup is opened
                        renderNotifications(); // Re-render to update counter display
                    }
                } else {
                    // Optionally, inform non-owners they can't view it
                    // For now, it simply won't open if not owner.
                    // A small, temporary message could be shown here.
                    console.log("Notifications are only visible to the room owner.");
                     // Example: alert("Notifications are only visible to the room owner.");
                }
            });


            // --- UI State Management ---
            function showAuthUI() {
                authContainer.style.display = 'block';
                roomDashboard.style.display = 'none';
                chatWrapper.style.display = 'none';
                mainHeaderBar.style.display = 'none';
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                authTitle.textContent = 'Login';
                authMessage.textContent = '';
            }

            async function showRoomDashboardUI(username) {
                currentUsername = username; // Set from login or session check
                authContainer.style.display = 'none';
                chatWrapper.style.display = 'none';
                roomDashboard.style.display = 'block';
                mainHeaderBar.style.display = 'flex';
                userInfoDisplay.textContent = `Logged in as: ${username}`;
                await loadUserRooms();
            }

            async function showChatUI(username, roomId, roomName, roomCreatorId) {
                currentUsername = username;
                currentRoomId = roomId;
                currentRoomCreatorId = roomCreatorId;
                oldestMessageIdLoaded = null;
                isLoadingHistory = false;
                chatOutput.innerHTML = ''; // Clear previous room's messages
                loadMoreMessagesButton.style.display = 'none'; // Hide load more button for new room initially

                // Reset notifications for the new room
                notifications = [];
                unreadNotificationCount = 0;
                renderNotifications(); // Update display (clear counter, empty list)
                notificationPopup.style.display = 'none'; // Ensure popup is hidden

                authContainer.style.display = 'none';
                roomDashboard.style.display = 'none';
                chatWrapper.style.display = 'flex';
                mainHeaderBar.style.display = 'flex';

                currentRoomDisplay.textContent = `Room: ${escapeHtml(roomName)}`;
                statusDisplay.textContent = 'Loading history...';

                await loadMessageHistory(roomId); // Initial load of messages

                statusDisplay.textContent = 'Connecting to chat...'; // Update status before WebSocket connect
                connectWebSocket(username, roomId);
                updateMemberInviteAreaVisibility();
                if (memberInviteArea.style.display !== 'none') {
                    // loadRoomMembers and loadInviteCandidates are called within updateMemberInviteAreaVisibility if needed
                    // or can be called here again if a specific order is required after WebSocket connection.
                    // For now, updateMemberInviteAreaVisibility handles it.
                }
            }

            // --- WebSocket Logic (Step 6) ---
            function connectWebSocket(username, roomId) {
                if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
                    console.log("WebSocket closing existing connection before opening new one.");
                    socket.close();
                }

                socket = new WebSocket(`ws://localhost:8080?username=${encodeURIComponent(username)}&roomId=${roomId}`);

                socket.onopen = function(e) {
                    statusDisplay.textContent = 'Connected';
                    console.log(`Connection established to room ${roomId}!`);
                    // Server join messages are now stored, so history will show them.
                    // Client-only confirmation for WebSocket connection:
                    addMessageToChat({type: 'server_message', text: `WebSocket connected to room '${escapeHtml(currentRoomDisplay.textContent.replace("Room: ",""))}'.`});
                };

                socket.onmessage = function(event) {
                    console.log(`Data received from server: ${event.data}`);
                    try {
                        const data = JSON.parse(event.data);
                        // Expecting live messages to have: { type, sender, text, roomId }
                        // System messages from server (like join/leave if not handled by history) might be 'server_message'
                        addMessageToChat(data); // Let addMessageToChat handle different types

                        // If a join/leave type of server_message, and current user is creator, refresh member list
                        // This is now primarily handled by history, but can be a fallback or for immediate updates.
                        // The Chat.php currently sends simple text for join/leave broadcasts.
                        if (data.type === 'server_message' && (data.text.includes('has joined') || data.text.includes('has left'))) {
                            if (parseInt(currentUserId) === parseInt(currentRoomCreatorId)) {
                                loadRoomMembers();
                                loadInviteCandidates(currentRoomId); // Also refresh candidates
                            }
                        }
                    } catch (error) {
                        console.warn("Received non-JSON message or malformed JSON from WebSocket:", event.data, error);
                        addMessageToChat({type: 'server_message', text: event.data}); // Display as plain server message
                    }
                };

                socket.onclose = function(event) {
                    statusDisplay.textContent = 'Disconnected';
                    // Determine if a specific reason was provided by the server or if it's an unclear closure
                    let specificReasonProvided = event.reason && event.reason.trim() !== "";
                    let reasonForDisplay = specificReasonProvided ? event.reason : 'Chat server unavailable or connection failed unexpectedly.';

                    // Log the original details from the event
                    console.log(`WebSocket closed: Code=${event.code}, Original Reason='${event.reason || 'N/A'}', Effective Reason='${reasonForDisplay}', WasClean=${event.wasClean}`);

                    // Special handling for client-initiated, expected closures (logout, navigation)
                    // These typically don't result in showing authUI with an error message.
                    if (event.code === 1000 && event.reason === "User logged out") {
                        // Handled by handleLogout(), which calls showAuthUI() without an error message.
                        // No explicit authMessage set here.
                    } else if (event.code === 1000 && event.reason === "Navigating away") {
                        // Handled by backToDashboardButton, which changes UI without error.
                        // No explicit authMessage set here.
                    } else {
                        // For all other closures (unexpected, server-initiated errors, or unclear network issues)
                        // For all other closures (unexpected, server-initiated errors, or unclear network issues)
                        // Display message in chat area and update status, but do not log out.
                        const closeMessage = `WebSocket connection closed. Chat is unavailable. (Code: ${event.code}, Reason: ${reasonForDisplay})`;
                        addMessageToChat({type: 'error', text: closeMessage}); // Using 'error' type for consistency
                        statusDisplay.textContent = 'Chat unavailable - Connection closed';
                        console.log(`WebSocket closed unexpectedly: ${closeMessage}`);
                        // No longer calling showAuthUI() here, and not setting authMessage.textContent
                    }
                    socket = null;
                };

                socket.onerror = function(error) {
                    statusDisplay.textContent = 'Connection Error!';
                    console.error(`WebSocket Error: `, error);
                    // Correctly structured call to addMessageToChat
                    addMessageToChat({type: 'error', text: 'Error: Could not connect to the chat server. WebSocket is unavailable.'});
                };
            }

            // --- API Calls & Related Logic (Step 5 & 7) ---

            async function loadMessageHistory(roomId, loadOlder = false) {
                if (isLoadingHistory) return;
                if (loadOlder && oldestMessageIdLoaded === -1) { // -1 signifies no more messages
                    loadMoreMessagesButton.style.display = 'none'; // Should already be hidden but ensure
                    return;
                }

                isLoadingHistory = true;
                loadMoreMessagesButton.textContent = 'Loading...';
                loadMoreMessagesButton.disabled = true;
                if(!loadOlder) loadMoreMessagesButton.style.display = 'none'; // Hide unless it's a "load older" specific request initially

                let queryParams = `roomId=${roomId}&limit=20`; // Fetch 20 messages at a time
                if (loadOlder && oldestMessageIdLoaded) {
                    queryParams += `&before_message_id=${oldestMessageIdLoaded}`;
                }

                try {
                    const response = await fetch(`get_room_messages.php?${queryParams}`);
                    const data = await response.json();

                    if (data.success && data.messages) {
                        if (data.messages.length > 0) {
                            const oldScrollHeight = chatOutput.scrollHeight;
                            const firstCurrentlyVisibleMessage = chatOutput.firstChild;

                            data.messages.forEach(msg => {
                                // API returns { id, roomId, userId, senderUsername, messageType, content, metadata, sentAt }
                                addMessageToChat(msg, true); // true for isHistory (prepend)
                            });

                            oldestMessageIdLoaded = data.messages[0].id; // First message in (originally reversed by API) array is oldest of this batch

                            if (loadOlder) {
                                // Try to maintain scroll position relative to the old top message
                                if(firstCurrentlyVisibleMessage) {
                                   chatOutput.scrollTop = firstCurrentlyVisibleMessage.offsetTop - chatOutput.offsetTop;
                                } else {
                                   chatOutput.scrollTop = chatOutput.scrollHeight - oldScrollHeight;
                                }
                            } else {
                                // Scroll to bottom for initial load
                                chatOutput.scrollTop = chatOutput.scrollHeight;
                            }

                            // Show "Load More" button only if we received a full batch of messages
                            if (data.messages.length >= 20) {
                                loadMoreMessagesButton.style.display = 'block';
                            } else {
                                loadMoreMessagesButton.style.display = 'none';
                                oldestMessageIdLoaded = -1; // Mark that we've reached the end
                            }
                        } else { // No messages returned
                            if (loadOlder) {
                                addMessageToChat({type: 'server', text: "No more messages to load."}, true);
                            } else {
                                // Initial load and no messages in room yet
                                addMessageToChat({type: 'server', text: "No messages in this room yet. Start the conversation!"});
                            }
                            loadMoreMessagesButton.style.display = 'none';
                            oldestMessageIdLoaded = -1;
                        }
                    } else {
                        addMessageToChat({type: 'server', text: data.message || "Could not load message history."}, loadOlder);
                        if(loadOlder) loadMoreMessagesButton.style.display = 'block'; // Allow retry if it was a "load older" attempt
                    }
                } catch (error) {
                    console.error("Error loading message history:", error);
                    addMessageToChat({type: 'server', text: "Error loading message history."}, loadOlder);
                     if(loadOlder) loadMoreMessagesButton.style.display = 'block'; // Allow retry
                } finally {
                    isLoadingHistory = false;
                    loadMoreMessagesButton.textContent = 'Load More Messages';
                    loadMoreMessagesButton.disabled = false;
                    // If initial load and no messages, ensure button is hidden
                    if (!loadOlder && oldestMessageIdLoaded === -1) {
                        loadMoreMessagesButton.style.display = 'none';
                    }
                }
            }

            async function loadUserRooms() {
                try {
                    const response = await fetch('list_my_rooms.php');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    roomListUL.innerHTML = ''; // Clear existing list
                    if (data.success && data.rooms.length > 0) {
                        data.rooms.forEach(room => {
                            const li = document.createElement('li');
                            li.textContent = room.name;
                            li.dataset.roomId = room.id;
                            li.dataset.roomName = room.name;
                            li.dataset.creatorId = room.creator_user_id;

                            const creatorSpan = document.createElement('span');
                            creatorSpan.className = 'room-creator';
                            creatorSpan.textContent = `Creator: ${room.creator_username}`;
                            li.appendChild(creatorSpan);

                            li.addEventListener('click', () => {
                                showChatUI(currentUsername, room.id, room.name, room.creator_user_id);
                            });
                            roomListUL.appendChild(li);
                        });
                    } else if (data.success && data.rooms.length === 0) {
                        roomListUL.innerHTML = '<li>No rooms found. Create one!</li>';
                    } else {
                        setDashboardMessage(data.message || 'Could not load rooms.', true);
                    }
                } catch (error) {
                    console.error('Error loading rooms:', error);
                    setDashboardMessage('Error loading rooms. Check connection.', true);
                }
            }

            createRoomForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const roomName = newRoomNameInput.value.trim();
                if (!roomName) {
                    setDashboardMessage('Room name cannot be empty.', true);
                    return;
                }
                try {
                    const response = await fetch('create_room.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ roomName })
                    });
                    const data = await response.json();
                    if (data.success) {
                        setDashboardMessage(`Room '${data.roomName}' created!`, false);
                        newRoomNameInput.value = '';
                        await loadUserRooms(); // Refresh list
                    } else {
                        setDashboardMessage(data.message || 'Failed to create room.', true);
                    }
                } catch (error) {
                    console.error('Error creating room:', error);
                    setDashboardMessage('Error creating room.', true);
                }
            });

            // --- Member Management (Step 7) ---
            function updateMemberInviteAreaVisibility() {
                if (currentUserId && currentRoomCreatorId && parseInt(currentUserId) === parseInt(currentRoomCreatorId)) {
                    memberInviteArea.style.display = 'flex';
                    loadInviteCandidates(currentRoomId); // Load candidates when area becomes visible
                } else {
                    memberInviteArea.style.display = 'none';
                }
            }

            async function loadInviteCandidates(roomId) {
                if (!roomId) return;
                try {
                    const response = await fetch(`list_invite_candidates.php?roomId=${roomId}`);
                    const data = await response.json();
                    inviteUserSelect.innerHTML = '<option value="">Select user to invite...</option>'; // Clear and add default
                    if (data.success && data.users) {
                        if (data.users.length === 0) {
                            const option = document.createElement('option');
                            option.value = "";
                            option.textContent = "No new users to invite";
                            option.disabled = true;
                            inviteUserSelect.appendChild(option);
                        } else {
                            data.users.forEach(user => {
                                const option = document.createElement('option');
                                option.value = user.username; // API `invite_to_room.php` expects username
                                option.textContent = escapeHtml(user.username);
                                inviteUserSelect.appendChild(option);
                            });
                        }
                    } else {
                        setMemberInviteMessage(data.message || 'Could not load invite candidates.', true);
                    }
                } catch (error) {
                    console.error('Error loading invite candidates:', error);
                    setMemberInviteMessage('Error loading invite candidates.', true);
                    inviteUserSelect.innerHTML = '<option value="">Error loading users</option>';
                }
            }

            async function loadRoomMembers() {
                if (!currentRoomId) return;
                try {
                    const response = await fetch(`get_room_members.php?roomId=${currentRoomId}`);
                    const data = await response.json();
                    memberListUL.innerHTML = '';
                    if (data.success && data.members) {
                        data.members.forEach(member => {
                            const li = document.createElement('li');
                            li.textContent = escapeHtml(member.username) + (member.userId === currentUserId ? ' (You)' : '');

                            if (currentUserId === currentRoomCreatorId && member.userId !== currentUserId) {
                                const removeBtn = document.createElement('button');
                                removeBtn.className = 'remove-member-btn';
                                removeBtn.textContent = 'Remove';
                                removeBtn.dataset.userId = member.userId;
                                removeBtn.onclick = () => handleRemoveMember(member.userId, member.username);
                                li.appendChild(removeBtn);
                            }
                            memberListUL.appendChild(li);
                        });
                    } else {
                        memberListUL.innerHTML = '<li>Could not load members.</li>';
                    }
                } catch (error) {
                    console.error('Error loading room members:', error);
                    memberListUL.innerHTML = '<li>Error loading members.</li>';
                }
            }

            inviteForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const selectedUsername = inviteUserSelect.value;
                if (!selectedUsername) {
                    setMemberInviteMessage('Please select a user to invite.', true);
                    return;
                }
                try {
                    const response = await fetch('invite_to_room.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ roomId: currentRoomId, targetUsername: selectedUsername })
                    });
                    const data = await response.json();
                    if (data.success) {
                        setMemberInviteMessage(data.message || `User '${selectedUsername}' invited.`, false);
                        // inviteUserSelect.value = ''; // Reset select - done by loadInviteCandidates
                        await loadRoomMembers();      // Refresh member list
                        await loadInviteCandidates(currentRoomId); // Refresh invite candidates
                    } else {
                        setMemberInviteMessage(data.message || 'Failed to invite user.', true);
                    }
                } catch (error) {
                    console.error('Error inviting user:', error);
                    setMemberInviteMessage('Error inviting user.', true);
                }
            });

            async function handleRemoveMember(userIdToRemove, usernameToRemove) {
                if (!confirm(`Are you sure you want to remove ${usernameToRemove} from this room?`)) {
                    return;
                }
                try {
                    const response = await fetch('remove_from_room.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ roomId: currentRoomId, targetUserIdToRemove: userIdToRemove })
                    });
                    const data = await response.json();
                    if (data.success) {
                        setMemberInviteMessage(data.message || `User '${usernameToRemove}' removed.`, false);
                        await loadRoomMembers(); // Refresh member list
                    } else {
                        setMemberInviteMessage(data.message || 'Failed to remove user.', true);
                    }
                } catch (error) {
                    console.error('Error removing user:', error);
                    setMemberInviteMessage('Error removing user.', true);
                }
            }


            // --- Initial Setup & Auth Flow ---
            async function checkUserSession() {
                try {
                    const response = await fetch('check_session.php');
                    const data = await response.json();
                    if (data.loggedIn && data.username && data.userId) {
                        currentUserId = data.userId; // Store logged in user's ID
                        await showRoomDashboardUI(data.username);
                    } else {
                        showAuthUI();
                    }
                } catch (error) {
                    console.error("Error checking session:", error);
                    showAuthUI();
                    authMessage.textContent = "Error contacting server. Please try again later.";
                }
            }

            showRegisterBtn.addEventListener('click', () => {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                authTitle.textContent = 'Register';
                authMessage.textContent = '';
            });

            showLoginBtn.addEventListener('click', () => {
                registerForm.style.display = 'none';
                loginForm.style.display = 'block';
                authTitle.textContent = 'Login';
                authMessage.textContent = '';
            });

            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                authMessage.textContent = '';

                try {
                    const response = await fetch('login.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await response.json();
                    if (data.success && data.username && data.userId) {
                        currentUserId = data.userId; // Store logged in user's ID
                        await showRoomDashboardUI(data.username);
                    } else {
                        authMessage.textContent = data.message || 'Login failed.';
                    }
                } catch (error) {
                    console.error("Login error:", error);
                    authMessage.textContent = "Error during login. Please try again.";
                }
            });

            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('register-username').value;
                const password = document.getElementById('register-password').value;
                authMessage.textContent = '';

                try {
                    const response = await fetch('register.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await response.json();
                    if (data.success) {
                        authMessage.textContent = (data.message || "Registration successful.") + " Please login.";
                        showLoginBtn.click();
                    } else {
                        authMessage.textContent = data.message || 'Registration failed.';
                    }
                } catch (error) {
                    console.error("Registration error:", error);
                    authMessage.textContent = "Error during registration. Please try again.";
                }
            });

            backToDashboardButton.addEventListener('click', async () => {
                if (socket) {
                    socket.close(1000, "Navigating away");
                    socket = null;
                }
                currentRoomId = null;
                currentRoomCreatorId = null;
                memberInviteArea.style.display = 'none'; // Hide member area
                inviteUserSelect.innerHTML = '<option value="">Select user to invite...</option>'; // Clear invite select

                // Clear notifications when going back to dashboard
                notifications = [];
                unreadNotificationCount = 0;
                renderNotifications();
                notificationPopup.style.display = 'none';

                await showRoomDashboardUI(currentUsername);
            });

            async function handleLogout(callApi = true) {
                if (callApi) {
                    try {
                        await fetch('logout.php', { method: 'POST' });
                    } catch (error) {
                        console.error("Logout API call failed:", error);
                    }
                }

                if (socket) {
                    socket.close(1000, "User logged out");
                    socket = null;
                }
                currentUsername = null;
                currentUserId = null;
                currentRoomId = null;
                currentRoomCreatorId = null;
                chatOutput.innerHTML = '';
                memberListUL.innerHTML = '';
                roomListUL.innerHTML = '';
                showAuthUI();
                document.getElementById('login-username').value = ''; // Clear login form
                document.getElementById('login-password').value = '';
            }

            logoutButton.addEventListener('click', () => handleLogout());

            sendButton.onclick = function() {
                const message = messageInput.value;
                if (message.trim() !== '' && socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(message); // Server now expects plain text for msg
                    messageInput.value = '';
                } else if (!socket || socket.readyState !== WebSocket.OPEN) {
                    addMessageToChat('server', null, "Not connected. Please select a room or try logging in again.");
                }
            };

            loadMoreMessagesButton.addEventListener('click', () => {
                if (currentRoomId && !isLoadingHistory) { // Ensure not already loading
                    loadMessageHistory(currentRoomId, true);
                }
            });

            chatOutput.addEventListener('scroll', () => {
                // Load more when scrolled to the top and button is visible (meaning more might be available)
                if (chatOutput.scrollTop === 0 && !isLoadingHistory && oldestMessageIdLoaded !== -1 && loadMoreMessagesButton.style.display === 'block') {
                    console.log("Scrolled to top, loading more messages...");
                    loadMessageHistory(currentRoomId, true);
                }
            });

            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendButton.click();
                }
            });

            // Initial Load
            checkUserSession();
        });
    </script>
</body>
</html>
