<!DOCTYPE html>
<html>
<head>
    <title>Chat App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; display: flex; flex-direction: column; height: 100vh; font-size: 14px; }
        .container { width: 100%; background-color: #fff; display: flex; flex-direction: column; flex-grow: 1; /* Removed max-width, margin, border-radius, box-shadow */}

        .header-bar { background-color: #007bff; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; /* Removed border-top-left-radius, border-top-right-radius */ }
        .header-bar #user-info { font-weight: bold; }
        .header-bar #logout-button { background-color: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .header-bar #logout-button:hover { background-color: #c82333; }

        /* Auth Forms */
        #auth-container { padding: 30px; }
        #auth-container h2 { text-align: center; margin-bottom: 20px; color: #333; }
        .auth-form { display: none; }
        .auth-form input[type="text"], .auth-form input[type="password"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .auth-form button[type="submit"] { width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .auth-form button[type="submit"]:hover { background-color: #0056b3; }
        .toggle-form { text-align: center; margin-top: 15px; }
        .toggle-form button { background: none; border: none; color: #007bff; cursor: pointer; text-decoration: underline; font-size: 0.9em; }
        #auth-message { text-align: center; margin-bottom: 15px; color: red; min-height: 1.2em; }

        /* Room Dashboard */
        #room-dashboard { padding: 20px; display: none; }
        #room-dashboard h2 { margin-top: 0; color: #333; text-align: center; }
        #room-dashboard h3 { margin-top: 20px; margin-bottom: 10px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        #create-room-form input[type="text"] { width: calc(70% - 12px); padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px;}
        #create-room-form button { padding: 8px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #create-room-form button:hover { background-color: #218838; }
        #room-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
        #room-list li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        #room-list li:last-child { border-bottom: none; }
        #room-list li:hover { background-color: #f0f0f0; }
        #room-list .room-creator { font-size: 0.8em; color: #777; }
        #dashboard-message { text-align: center; margin-top: 10px; color: #555; }


        /* Chat Area */
        #chat-wrapper { display: none; flex-grow: 1; flex-direction: column; }
        #chat-header { background-color: #6c757d; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        #chat-header #current-room-display { font-weight: bold; }
        #chat-header #back-to-dashboard { background-color: #ffc107; color: #212529; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        #chat-header #back-to-dashboard:hover { background-color: #e0a800; }

        /* Notification Button & Popup Styles */
        #notification-button { background-color: transparent; color: white; border: none; font-size: 1.2em; cursor: pointer; padding: 5px; position: relative; }
        #notification-button:hover { opacity: 0.8; }
        #notification-counter { position: absolute; top: -2px; right: -4px; background-color: red; color: white; border-radius: 50%; padding: 1px 4px; font-size: 0.65em; line-height: 1; display: none; /* Initially hidden */ }
        #notification-popup {
            display: none; /* Initially hidden */
            position: absolute; /* Relative to chat-container */
            top: 10px; /* Small padding from the top of chat-container */
            right: 10px; /* Small padding from the right of chat-container */
            width: calc(100% - 40px); /* Adjust width, consider padding of parent */
            max-width: 300px; /* Max width for readability */
            max-height: calc(100% - 60px); /* Adjust based on chat-container height and input area, leave space for input area */
            overflow-y: auto;
            background-color: #f9f9f9; /* Slightly different background to distinguish */
            border: 1px solid #ddd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10; /* Above chat messages but below overall modals if any */
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        #notification-popup h4 { margin-top: 0; margin-bottom: 10px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        #notification-list { list-style-type: decimal; /* Numbered list */ padding-left: 20px; /* Space for numbers */ margin: 0; }
        #notification-list li { padding: 6px 0; border-bottom: 1px solid #f0f0f0; color: #555; }
        #notification-list li:last-child { border-bottom: none; }
        .notification-timestamp { font-size: 0.8em; color: #888; margin-left: 8px; }


        #chat-content-wrapper { display: flex; flex-grow: 1; overflow: hidden; }

        #chat-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; /* For load more button */ }
        #load-more-messages { display: none; /* Hidden by default */ width: auto; margin: 10px auto 0px auto; padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; text-align: center;}
        #load-more-messages:hover { background-color: #5a6268; }

        #chat-output { /* height: 300px; Adjusted for member list */ overflow-y: auto; padding: 15px; border-bottom: 1px solid #eee; flex-grow: 1;}
        .message { margin-bottom: 12px; line-height: 1.4; }
        .message .sender { font-weight: bold; color: #007bff; }
        .message .text { margin-left: 8px; color: #333; word-wrap: break-word; }
        .server-message { font-style: italic; color: #6c757d; text-align: center; margin-bottom: 10px; font-size: 0.9em;}
        #input-area { display: flex; padding: 15px; border-top: 1px solid #eee; background-color: #f8f9fa; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; }
        #send-button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #send-button:hover { background-color: #0056b3; }
        #status { padding: 8px 15px; background-color: #e9ecef; text-align: center; font-size: 0.85em; color: #495057; border-bottom: 1px solid #ddd;}

        /* Member List & Invite Area */
        #member-invite-area { width: 200px; border-left: 1px solid #ddd; padding: 15px; background-color: #f8f9fa; display: flex; flex-direction: column; }
        #member-invite-area h4 { margin-top: 0; margin-bottom: 10px; font-size: 1.1em; color: #333; }
        #member-list { list-style: none; padding: 0; margin-bottom: 15px; max-height: 150px; overflow-y: auto; }
        #member-list li { padding: 5px 0; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        #member-list .remove-member-btn { background: none; border: none; color: #dc3545; cursor: pointer; font-size: 0.8em; padding: 2px 5px;}
        #member-list .remove-member-btn:hover { text-decoration: underline; }

        /* #invite-form input[type="text"] { width: calc(100% - 18px); padding: 6px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.9em;} */ /* Replaced by select */
        #invite-form select#invite-user-select { /* Style already applied inline, but can be centralized here */ }
        #invite-form button { width: 100%; padding: 6px; background-color: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.9em;}
        #invite-form button:hover { background-color: #138496; }
        #member-invite-message { font-size: 0.8em; color: green; margin-top: 5px; min-height: 1em;}


        /* Styles from white_chat.html */
        .chat-online {
            color: #34ce57
        }

        .chat-offline {
            color: #e4606d
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            max-height: 800px; /* Consider adjusting this based on overall layout */
            overflow-y: scroll
        }

        .chat-message-left,
        .chat-message-right {
            display: flex;
            flex-shrink: 0
        }

        .chat-message-left {
            margin-right: auto
        }

        .chat-message-right {
            flex-direction: row-reverse;
            margin-left: auto
        }
        /* Bootstrap utility classes from white_chat.html - may be redundant but included for fidelity */
        /*
        .py-3 {
            padding-top: 1rem!important;
            padding-bottom: 1rem!important;
        }
        .px-4 {
            padding-right: 1.5rem!important;
            padding-left: 1.5rem!important;
        }
        .flex-grow-0 {
            flex-grow: 0!important;
        }
        .border-top {
            border-top: 1px solid #dee2e6!important;
        }
        */
        /* End Styles from white_chat.html */


        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            body { font-size: 13px; } /* Slightly smaller base font */

            .header-bar, #chat-header, #input-area { padding: 10px; }
            #auth-container, #room-dashboard { padding: 15px; }

            #room-dashboard h2 { font-size: 1.5em; }
            #room-dashboard h3 { font-size: 1.1em; }
            #create-room-form input[type="text"] { width: calc(100% - 90px); /* Adjust based on button width */ }
            #room-list li { padding: 8px; }


            #chat-content-wrapper { flex-direction: column; }
            #member-invite-area {
                width: 100%; /* Take full width */
                border-left: none; /* Remove left border */
                border-top: 1px solid #ddd; /* Add top border */
                max-height: 250px; /* Limit height when stacked */
                overflow-y: auto;
            }
            #member-invite-area h4 { font-size: 1em; margin-bottom: 8px; }
            #member-list { max-height: 120px; /* Adjust height for stacked view */ }
            #invite-form select#invite-user-select, #invite-form button { font-size: 0.85em; padding: 8px; }


            #chat-output { padding: 10px; }
            .message .sender { font-size: 0.95em; }
            .message .text { font-size: 0.9em; }

            #message-input { padding: 8px; margin-right: 8px; }
            #send-button, #back-to-dashboard, .header-bar #logout-button { padding: 8px 12px; font-size: 0.9em; }

            /* Auth forms adjustments */
            .auth-form input[type="text"], .auth-form input[type="password"] { padding: 12px; }
            .auth-form button[type="submit"] { padding: 12px; font-size: 1em; }

            /* Notification popup adjustments for smaller screens */
            #notification-popup {
                top: 5px;
                right: 5px;
                width: calc(100% - 10px); /* More screen width */
                max-height: calc(100% - 50px); /* Adjust max height */
                font-size: 0.85em;
            }
             #notification-button { font-size: 1.1em; }
        }

        @media (max-width: 480px) {
            body { font-size: 12px; }
            .header-bar, #chat-header, #input-area { padding: 8px; }
            #auth-container, #room-dashboard { padding: 10px; }

            #create-room-form input[type="text"] { width: calc(100% - 80px); } /* Further adjust */
            #create-room-form button { padding: 8px 10px; }


            #chat-header #current-room-display { font-size: 0.9em; }
            #back-to-dashboard { font-size: 0.8em; padding: 6px 8px; }
            .header-bar #logout-button { font-size: 0.8em; padding: 6px 8px; }


            #send-button { padding: 8px 15px; }

            /* Make member/invite area more compact if it's visible */
            #member-invite-area { max-height: 200px; }
            #member-list { max-height: 100px; }
        }
    </style>
</head>
<body>
    <style>
        /* Add styles for the new DM layout */
        #main-app-container { display: none; flex-direction: column; flex-grow: 1; }
        .app-navigation { display: flex; background-color: #e9ecef; padding: 10px; border-bottom: 1px solid #ddd;}
        .app-navigation button { background-color: #007bff; color: white; border: none; padding: 10px 15px; margin-right: 10px; border-radius: 4px; cursor: pointer; }
        .app-navigation button.active { background-color: #0056b3; }
        .app-navigation button:hover { background-color: #0056b3; }

        #dm-section, #rooms-section { display: none; flex-grow: 1; flex-direction: column; padding:15px; }
        #dm-section.active, #rooms-section.active { display: flex; }

        #dm-layout { display: flex; flex-grow: 1; overflow: hidden; }
        #user-list-sidebar { width: 250px; border-right: 1px solid #ddd; padding: 15px; background-color: #f8f9fa; overflow-y: auto; }
        #user-list-sidebar h3 { margin-top: 0; font-size: 1.2em; }
        #contacts-list { list-style: none; padding: 0; }
        #contacts-list li { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        #contacts-list li:hover, #contacts-list li.active { background-color: #e9ecef; }

        #dm-chat-area { flex-grow: 1; display: flex; flex-direction: column; }
        #dm-chat-header { padding: 10px 20px; background-color: #6c757d; color: white; font-weight: bold; }
        #dm-chat-output { flex-grow: 1; overflow-y: auto; padding: 15px; border-bottom: 1px solid #eee;}
        #dm-input-area { display: flex; padding: 15px; border-top: 1px solid #eee; background-color: #f8f9fa; }
        #dm-message-input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; }
        #dm-send-button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #dm-send-button:hover { background-color: #0056b3; }

        /* Ensure existing room styles don't conflict heavily */
        #room-dashboard { padding: 0; /* Reset padding if it was part of #rooms-section directly */ }
        #chat-wrapper { padding: 0; /* Reset padding */ }
    </style>
    <div class="container">
        <div class="header-bar" style="display: none;" id="main-header-bar">
            <span id="user-info"></span>
            <button id="logout-button">Logout</button>
        </div>

        <!-- Authentication Forms -->
        <div id="auth-container">
            <h2 id="auth-title">Login</h2>
            <div id="auth-message"></div>
            <form id="login-form" class="auth-form">
                <input type="text" id="login-username" placeholder="Username" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit">Login</button>
                <div class="toggle-form">
                    Don't have an account? <button type="button" id="show-register">Register here</button>
                </div>
            </form>
            <form id="register-form" class="auth-form">
                <input type="text" id="register-username" placeholder="Username" required>
                <input type="password" id="register-password" placeholder="Password" required>
                <button type="submit">Register</button>
                <div class="toggle-form">
                    Already have an account? <button type="button" id="show-login">Login here</button>
                </div>
            </form>
        </div>

        <!-- Main Application Container (Post-Login) -->
        <div id="main-app-container">
            <div class="app-navigation">
                <button id="nav-dm-button" class="active">Direct Messages</button>
                <button id="nav-rooms-button">Chat Rooms</button>
            </div>

            <!-- Direct Messages Section -->
            <section id="dm-section" class="active">
                <div id="dm-layout">
                    <aside id="user-list-sidebar">
                        <h3>Contacts</h3>
                        <ul id="contacts-list">
                            <!-- User contacts will be populated by JS -->
                        </ul>
                    </aside>
                    <main id="dm-chat-area">
                        <div id="dm-chat-header">Select a contact to start chatting</div>
                        <div id="dm-chat-output" class="chat-messages p-4">
                            <!-- Direct messages will be dynamically added here -->
                        </div>
                        <div id="dm-input-area" class="flex-grow-0 py-3 px-4 border-top" style="display:none;">
                            <input type="text" id="dm-message-input" class="form-control" placeholder="Type your message...">
                            <button id="dm-send-button" class="btn btn-primary">Send</button>
                        </div>
                    </main>
                </div>
            </section>

            <!-- Chat Rooms Section -->
            <section id="rooms-section">
                <!-- Existing Room Dashboard -->
                <div id="room-dashboard">
                    <h2>Room Dashboard</h2>
                    <div id="dashboard-message"></div>
                    <form id="create-room-form">
                        <h3>Create New Room</h3>
                        <input type="text" id="new-room-name" placeholder="Enter room name" required>
                        <button type="submit">Create Room</button>
                    </form>
                    <h3>Your Rooms</h3>
                    <ul id="room-list">
                        <!-- Room items will be populated by JS -->
                    </ul>
                </div>

                <!-- Existing Chat Application (for rooms) -->
                <div id="chat-wrapper"> <!-- This is the room chat -->
                    <div id="chat-header">
                        <span id="current-room-display"></span>
                        <div>
                            <button id="notification-button" style="position: relative; margin-right: 10px;">
                                &#128276; <!-- Bell icon -->
                                <span id="notification-counter" style="position: absolute; top: -5px; right: -5px; background-color: red; color: white; border-radius: 50%; padding: 2px 5px; font-size: 0.7em; display: none;">0</span>
                            </button>
                            <button id="back-to-dashboard">Back to Rooms</button>
                        </div>
                    </div>
                    <div id="status">Connecting...</div>
                    <div id="chat-content-wrapper">
                        <div id="chat-container">
                            <div id="notification-popup" style="display: none;">
                                <h4>Room Activity</h4>
                                <ul id="notification-list" style="list-style-type: none; padding: 0; margin: 0;"></ul>
                            </div>
                            <button id="load-more-messages">Load More Messages</button>
                            <div id="chat-output" class="chat-messages p-4">
                                <!-- Room messages will be dynamically added here -->
                            </div>
                            <div id="input-area" class="flex-grow-0 py-3 px-4 border-top">
                                <div class="input-group">
                                    <input type="text" id="message-input" class="form-control" placeholder="Type your message...">
                                    <button id="send-button" class="btn btn-primary">Send</button>
                                </div>
                            </div>
                        </div>
                        <div id="member-invite-area" style="display: none;">
                            <h4>Members</h4>
                            <ul id="member-list"></ul>
                            <div id="member-invite-message"></div>
                            <form id="invite-form">
                                <h4>Invite User</h4>
                                <select id="invite-user-select" required style="width: 100%; padding: 6px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.9em; background-color: white;">
                                    <option value="">Select user to invite...</option>
                                </select>
                                <button type="submit">Invite</button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // UI Elements - General App
            const mainAppContainer = document.getElementById('main-app-container');
            const navDmButton = document.getElementById('nav-dm-button');
            const navRoomsButton = document.getElementById('nav-rooms-button');
            const dmSection = document.getElementById('dm-section');
            const roomsSection = document.getElementById('rooms-section');

            // UI Elements - DM
            const contactsListUL = document.getElementById('contacts-list');
            const dmChatHeader = document.getElementById('dm-chat-header');
            const dmChatOutput = document.getElementById('dm-chat-output');
            const dmInputArea = document.getElementById('dm-input-area');
            const dmMessageInput = document.getElementById('dm-message-input');
            const dmSendButton = document.getElementById('dm-send-button');

            // UI Elements - Auth
            const authContainer = document.getElementById('auth-container');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const authMessage = document.getElementById('auth-message');
            const authTitle = document.getElementById('auth-title');
            const showRegisterBtn = document.getElementById('show-register');
            const showLoginBtn = document.getElementById('show-login');

            // UI Elements - Main Header
            const mainHeaderBar = document.getElementById('main-header-bar');
            const userInfoDisplay = document.getElementById('user-info');
            const logoutButton = document.getElementById('logout-button');

            // --- App Navigation & Sections ---
            // const mainAppContainer = document.getElementById('main-app-container'); // Defined above in HTML script block
            // const navDmButton = document.getElementById('nav-dm-button'); // Defined above
            // const navRoomsButton = document.getElementById('nav-rooms-button'); // Defined above
            // const dmSection = document.getElementById('dm-section'); // Defined above
            // const roomsSection = document.getElementById('rooms-section'); // Defined above

            // --- DM UI Elements ---
            // const contactsListUL = document.getElementById('contacts-list'); // Defined above
            // const dmChatHeader = document.getElementById('dm-chat-header'); // Defined above
            // const dmChatOutput = document.getElementById('dm-chat-output'); // Defined above
            // const dmInputArea = document.getElementById('dm-input-area'); // Defined above
            // const dmMessageInput = document.getElementById('dm-message-input'); // Defined above
            // const dmSendButton = document.getElementById('dm-send-button'); // Defined above
            let currentDmContactId = null; // Stores the userId of the currently active DM chat contact
            let currentDmContactUsername = null;
            let oldestDmMessageIdLoaded = null;
            let isLoadingDmHistory = false;


            // --- Room UI Elements ---
            const roomDashboard = document.getElementById('room-dashboard');
            const createRoomForm = document.getElementById('create-room-form');
            const newRoomNameInput = document.getElementById('new-room-name');
            const roomListUL = document.getElementById('room-list');
            const dashboardMessage = document.getElementById('dashboard-message');

            const chatWrapper = document.getElementById('chat-wrapper'); // This is for room chat
            const chatHeader = document.getElementById('chat-header'); // Room chat header
            const currentRoomDisplay = document.getElementById('current-room-display');
            const backToDashboardButton = document.getElementById('back-to-dashboard');
            const statusDisplay = document.getElementById('status'); // Room chat status
            const chatOutput = document.getElementById('chat-output'); // Room chat message area
            const messageInput = document.getElementById('message-input'); // Room message input
            const sendButton = document.getElementById('send-button'); // Room message send
            const loadMoreMessagesButton = document.getElementById('load-more-messages'); // Room messages load more

            // Notifications (currently room-specific, might need to generalize or have DM notifications)
            const notificationButton = document.getElementById('notification-button');
            const notificationCounter = document.getElementById('notification-counter');
            const notificationPopup = document.getElementById('notification-popup');
            const notificationListUL = document.getElementById('notification-list');

            // Member/Invite Area (room-specific)
            const memberInviteArea = document.getElementById('member-invite-area');
            const memberListUL = document.getElementById('member-list');
            const inviteForm = document.getElementById('invite-form');
            const inviteUserSelect = document.getElementById('invite-user-select');
            const memberInviteMessage = document.getElementById('member-invite-message');

            // --- Global State ---
            let socket = null;
            let currentUsername = null;
            let currentUserId = null;

            // Room-specific state
            let currentRoomId = null;
            let currentRoomCreatorId = null;
            let oldestRoomMessageIdLoaded = null;
            let isLoadingRoomHistory = false;

            // Notification state (currently room-centric)
            let notifications = [];
            let unreadNotificationCount = 0;

            // --- Utility Functions ---
            function escapeHtml(unsafe) {
                return unsafe
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
            }

            // --- UI State Management ---
            function showAuthUI() {
                authContainer.style.display = 'block';
                mainAppContainer.style.display = 'none'; // Hide main app view
                mainHeaderBar.style.display = 'none';
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                authTitle.textContent = 'Login';
                authMessage.textContent = '';
            }

            async function showMainAppUI(username) {
                currentUsername = username; // Set from login or session check
                authContainer.style.display = 'none';
                mainAppContainer.style.display = 'flex'; // Show main app view
                mainHeaderBar.style.display = 'flex';
                userInfoDisplay.textContent = `Logged in as: ${username}`;

                // Establish general WebSocket connection for DMs (no specific room yet)
                connectWebSocket(currentUsername); // Pass only username initially

                await loadContacts();
                showDmUI(); // Default to DM view
            }

            function showDmUI() {
                dmSection.classList.add('active');
                roomsSection.classList.remove('active');
                navDmButton.classList.add('active');
                navRoomsButton.classList.remove('active');

                // If returning to DM view and a contact was selected, re-select them?
                // Or clear selection:
                if (!currentDmContactId) { // If no contact is active, show placeholder
                    dmChatHeader.textContent = 'Select a contact to start chatting';
                    dmChatOutput.innerHTML = '';
                    dmInputArea.style.display = 'none';
                } else {
                    // If a DM contact is already active, their chat is presumably already loaded or will be.
                    // This logic might need adjustment if switching back and forth rapidly.
                }
                // Hide room-specific elements if they were visible
                chatWrapper.style.display = 'none';
                roomDashboard.style.display = 'none';
            }

            function showRoomsUI() {
                dmSection.classList.remove('active');
                roomsSection.classList.add('active');
                navDmButton.classList.remove('active');
                navRoomsButton.classList.add('active');

                // Show room dashboard by default when entering "Chat Rooms"
                roomDashboard.style.display = 'block';
                chatWrapper.style.display = 'none'; // Hide room chat area initially

                // If currentDmContactId is set, clear it as we are moving away from DMs
                // clearActiveDmContact(); // Optional: clear DM state when switching to rooms
                loadUserRooms(); // Refresh room list
            }

            // Modified to show room dashboard first within the #rooms-section
            async function showRoomDashboardUI() { // Called when 'Back to Rooms' is clicked or navigating to rooms tab
                // Assumes showRoomsUI() has already made #rooms-section active
                roomDashboard.style.display = 'block';
                chatWrapper.style.display = 'none';

                if (socket && currentRoomId) { // If connected to a room's WebSocket, close it or send leave.
                    // Server's onClose will handle room leave if socket is closed.
                    // Alternatively, send a specific "leave_room" WS message if implemented.
                    console.log(`Leaving room ${currentRoomId} context.`);
                    // For simplicity, if user goes to dashboard, we might not need to close the *general* WS
                    // but if WS was room-specific, it should be closed or its context changed.
                    // Current `connectWebSocket` establishes a new one for each room, so closing is fine.
                    if(socket.roomId === currentRoomId) { // Check if socket is specific to this room
                         socket.close(1000, "Navigating away from room");
                         socket = null; // Allow re-connection to a new room or general DM state
                    }
                }
                currentRoomId = null;
                currentRoomCreatorId = null;
                memberInviteArea.style.display = 'none';
                inviteUserSelect.innerHTML = '<option value="">Select user to invite...</option>';

                // Re-establish general WebSocket if it was closed or specific to a room
                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    connectWebSocket(currentUsername);
                }
                await loadUserRooms();
            }

            // Modified to fit within #rooms-section
            async function showChatUI(roomId, roomName, roomCreatorId) { // For rooms
                currentRoomId = roomId;
                currentRoomCreatorId = roomCreatorId;
                oldestRoomMessageIdLoaded = null;
                isLoadingRoomHistory = false;
                chatOutput.innerHTML = '';
                loadMoreMessagesButton.style.display = 'none';

                notifications = [];
                unreadNotificationCount = 0;
                renderNotifications();
                notificationPopup.style.display = 'none';

                roomDashboard.style.display = 'none'; // Hide dashboard
                chatWrapper.style.display = 'flex';  // Show room chat area

                currentRoomDisplay.textContent = `Room: ${escapeHtml(roomName)}`;
                statusDisplay.textContent = 'Loading room history...';

                await loadRoomMessageHistory(roomId);

                statusDisplay.textContent = 'Connecting to room chat...';
                // Close existing general socket or room-specific socket before connecting to a new room
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.close(1000, "Switching to new room context");
                }
                connectWebSocket(currentUsername, roomId); // Connect specifically to this room

                updateMemberInviteAreaVisibility();
            }

            // --- Add Direct Message to Chat UI ---
            function addDirectMessageToChat(data, isHistory = false) {
                // Expected data: { id, sender_user_id, sender_username, content, sent_at }
                // For live WS: { type: 'direct_message', message_id, sender_user_id, sender_username, receiver_user_id, text, timestamp }

                const messageId = data.id || data.message_id;
                const senderId = data.sender_user_id;
                const senderUsername = data.sender_username || "Unknown";
                const content = data.content || data.text || "";
                // const sentAt = data.sent_at || data.timestamp || new Date().toISOString();

                const isMe = parseInt(senderId) === parseInt(currentUserId);

                const messageWrapperDiv = document.createElement('div');
                if (messageId) {
                    messageWrapperDiv.dataset.messageId = messageId;
                }
                messageWrapperDiv.classList.add(isMe ? 'chat-message-right' : 'chat-message-left', 'pb-4');

                const messageBubbleDiv = document.createElement('div');
                messageBubbleDiv.classList.add('flex-shrink-1', 'bg-light', 'rounded', 'py-2', 'px-3');
                messageBubbleDiv.classList.add(isMe ? 'mr-3' : 'ml-3');

                const senderNameDiv = document.createElement('div');
                senderNameDiv.classList.add('font-weight-bold', 'mb-1');
                senderNameDiv.textContent = escapeHtml(senderUsername);

                const messageTextNode = document.createTextNode(escapeHtml(content));

                messageBubbleDiv.appendChild(senderNameDiv);
                messageBubbleDiv.appendChild(messageTextNode);

                // Avatar placeholder (optional, for structure)
                const avatarPlaceholderDiv = document.createElement('div');
                messageWrapperDiv.appendChild(avatarPlaceholderDiv);
                messageWrapperDiv.appendChild(messageBubbleDiv);

                if (isHistory) {
                    dmChatOutput.insertBefore(messageWrapperDiv, dmChatOutput.firstChild);
                } else {
                    dmChatOutput.appendChild(messageWrapperDiv);
                    dmChatOutput.scrollTop = dmChatOutput.scrollHeight;
                }
            }


            // --- Add Room Message to Chat UI (formerly addMessageToChat) ---
            function addRoomMessageToChat(data, isHistory = false) {
                // data for history: { id, senderUsername, content, messageType, sentAt, userId (sender's ID) }
                // data for live WS (room_message): { type, message_id, sender_user_id, sender_username, room_id, text, timestamp }
                // data for live WS (server_message): { type, text, roomId } (for join/leave)

                let SENDER_ID = data.sender_user_id || data.userId;
                let SENDER_USERNAME = data.sender_username || data.senderUsername || data.sender || "System";
                let CONTENT_TEXT = data.text || data.content || "";
                // MESSAGE_TYPE for history can be 'text', 'system_join', 'system_leave'.
                // For live, data.type will be 'room_message' or 'server_message'.
                let MESSAGE_TYPE_FROM_DATA = data.messageType || data.type;
                let MESSAGE_ID = data.id || data.message_id;

                const isMe = parseInt(SENDER_ID) === parseInt(currentUserId);

                // --- Notification Filtering for join/leave messages (specific to rooms) ---
                const isJoinLeaveServerMessage = MESSAGE_TYPE_FROM_DATA === 'server_message' && (CONTENT_TEXT.includes(' has joined the room') || CONTENT_TEXT.includes(' has left the room'));
                const isJoinLeaveHistoryMessage = MESSAGE_TYPE_FROM_DATA === 'system_join' || MESSAGE_TYPE_FROM_DATA === 'system_leave';

                if (isJoinLeaveServerMessage || isJoinLeaveHistoryMessage) {
                    let notificationText = CONTENT_TEXT;
                    if (isJoinLeaveHistoryMessage) { // History content for join/leave is JSON
                        try {
                            const parsedContent = JSON.parse(CONTENT_TEXT);
                            notificationText = parsedContent.text || CONTENT_TEXT;
                        } catch (e) { /* Fallback */ }
                    }
                    addNotification(escapeHtml(notificationText), data.sent_at || data.timestamp);
                    return; // Do not display join/leave messages in the main chat output
                }

                // Filter out "WebSocket connected..." messages
                if (MESSAGE_TYPE_FROM_DATA === 'server_message' && CONTENT_TEXT.startsWith('WebSocket connected to room')) {
                    console.log("Filtered out WebSocket room connect message:", CONTENT_TEXT);
                    return;
                }
                 if (MESSAGE_TYPE_FROM_DATA === 'system_message' && CONTENT_TEXT.startsWith('Successfully connected to the chat server')) {
                    console.log("Filtered out general WebSocket connect message:", CONTENT_TEXT);
                    // This could be displayed in a global status area if desired.
                    return;
                }


                const messageWrapperDiv = document.createElement('div');
                if (MESSAGE_ID) {
                    messageWrapperDiv.dataset.messageId = MESSAGE_ID;
                }

                if (MESSAGE_TYPE_FROM_DATA === 'server_message' || MESSAGE_TYPE_FROM_DATA === 'error' || MESSAGE_TYPE_FROM_DATA === 'system_message') {
                    messageWrapperDiv.classList.add('server-message', 'text-muted', 'small', 'text-center', 'my-2');
                    messageWrapperDiv.textContent = escapeHtml(CONTENT_TEXT);
                } else { // Regular user messages (assuming 'text' from history or 'room_message' from live)
                    messageWrapperDiv.classList.add(isMe ? 'chat-message-right' : 'chat-message-left', 'pb-4');
                    const messageBubbleDiv = document.createElement('div');
                    messageBubbleDiv.classList.add('flex-shrink-1', 'bg-light', 'rounded', 'py-2', 'px-3');
                    messageBubbleDiv.classList.add(isMe ? 'mr-3' : 'ml-3');

                    const senderNameDiv = document.createElement('div');
                    senderNameDiv.classList.add('font-weight-bold', 'mb-1');
                    senderNameDiv.textContent = escapeHtml(SENDER_USERNAME);

                    const messageTextNode = document.createTextNode(escapeHtml(CONTENT_TEXT));
                    messageBubbleDiv.appendChild(senderNameDiv);
                    messageBubbleDiv.appendChild(messageTextNode);

                    const avatarPlaceholderDiv = document.createElement('div');
                    messageWrapperDiv.appendChild(avatarPlaceholderDiv);
                    messageWrapperDiv.appendChild(messageBubbleDiv);
                }

                const targetOutput = chatOutput; // Room messages go to #chat-output
                if (isHistory) {
                    targetOutput.insertBefore(messageWrapperDiv, targetOutput.firstChild);
                } else {
                    targetOutput.appendChild(messageWrapperDiv);
                    targetOutput.scrollTop = targetOutput.scrollHeight;
                }
            }


            function setDashboardMessage(message, isError = false) {
                dashboardMessage.textContent = message;
                dashboardMessage.style.color = isError ? 'red' : 'green';
                setTimeout(() => dashboardMessage.textContent = '', 3000);
            }

            function setMemberInviteMessage(message, isError = false) {
                memberInviteMessage.textContent = message;
                memberInviteMessage.style.color = isError ? 'red' : 'green';
                setTimeout(() => memberInviteMessage.textContent = '', 3000);
            }

            // --- Notification Logic (Room Specific for now) ---
            function renderNotifications() {
                notificationListUL.innerHTML = '';
                notifications.forEach(notif => {
                    const li = document.createElement('li');
                    li.textContent = notif.text;
                    notificationListUL.appendChild(li);
                });
                notificationCounter.textContent = unreadNotificationCount > 0 ? unreadNotificationCount : '';
                notificationCounter.style.display = unreadNotificationCount > 0 ? 'block' : 'none';
            }

            function addNotification(messageText, messageTimestamp) {
                if (notifications.length >= 50) notifications.shift();
                notifications.push({ text: messageText, timestamp: messageTimestamp });
                unreadNotificationCount++;
                renderNotifications();
            }

            notificationButton.addEventListener('click', () => {
                if (currentRoomId && parseInt(currentUserId) === parseInt(currentRoomCreatorId)) { // Room context check
                    notificationPopup.style.display = notificationPopup.style.display === 'none' ? 'block' : 'none';
                    if (notificationPopup.style.display === 'block') {
                        unreadNotificationCount = 0;
                        renderNotifications();
                    }
                } else if (currentRoomId) {
                    alert("Notifications (join/leave messages) are typically viewed by the room creator.");
                }
            });

            // --- WebSocket Logic ---
            // `username` is current logged-in user. `roomId` is optional.
            // If `roomId` is provided, it's for a room-specific context.
            // If `roomId` is NOT provided, it's a general connection for DMs.
            function connectWebSocket(username, targetRoomId = null) {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    // If trying to connect to a different context (e.g. different room, or general vs room)
                    if (socket.targetRoomId !== targetRoomId) {
                        console.log(`Closing existing WebSocket (target: ${socket.targetRoomId}) to connect to new target: ${targetRoomId}.`);
                        socket.close(1000, "Switching connection context");
                        socket = null; // Ensure it's reset
                    } else {
                        console.log("WebSocket already connected to the target context.");
                        if(targetRoomId) statusDisplay.textContent = 'Connected'; // Update room status
                        return; // Already connected to the correct context
                    }
                }
                if (socket && socket.readyState === WebSocket.CONNECTING) {
                    console.log("WebSocket connection attempt already in progress.");
                    return;
                }

                let wsUrl = `ws://localhost:8080?username=${encodeURIComponent(username)}`;
                if (targetRoomId) {
                    wsUrl += `&roomId=${targetRoomId}`;
                }
                console.log(`Connecting WebSocket to: ${wsUrl}`);
                socket = new WebSocket(wsUrl);
                socket.targetRoomId = targetRoomId; // Store what this socket is for

                socket.onopen = function(e) {
                    console.log(`WebSocket connected. Target Room ID: ${targetRoomId || 'N/A (DM mode)'}`);
                    if (targetRoomId) { // If this is a room connection
                        statusDisplay.textContent = 'Connected';
                        // Server now sends join messages that are caught by history, so client-side add might be redundant
                        // addRoomMessageToChat({type: 'server_message', text: `WebSocket connected to room '${escapeHtml(currentRoomDisplay.textContent.replace("Room: ",""))}'.`});
                    } else { // General DM connection
                        // Could update a global status indicator here if one existed
                        console.log("WebSocket ready for Direct Messages.");
                    }
                };

                socket.onmessage = function(event) {
                    console.log(`WS Data received: ${event.data}`);
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'direct_message') {
                            // Ensure it's for the currently active DM chat or a notification for another
                            if (data.sender_user_id == currentDmContactId || data.receiver_user_id == currentDmContactId) {
                                addDirectMessageToChat(data);
                            } else {
                                // TODO: Implement notifications for DMs from other users
                                console.log("Received DM for non-active contact:", data);
                                alert(`New DM from ${data.sender_username}!`); // Simple alert for now
                            }
                        } else if (data.type === 'room_message' || data.type === 'server_message' || data.type === 'system_join' || data.type === 'system_leave') {
                            if (data.roomId == currentRoomId || (data.type === 'server_message' && !data.roomId)) { // Ensure message is for current room or global server message
                                addRoomMessageToChat(data);
                            } else {
                                console.log("Received room message for a different room:", data);
                                // Could be a notification for another room activity
                            }
                        } else if (data.type === 'error') {
                            console.error("WebSocket error message from server:", data.text);
                            // Display error in appropriate context (DM or Room status)
                            if (targetRoomId) statusDisplay.textContent = `Error: ${data.text}`;
                            else alert(`Server Error: ${data.text}`);
                        } else if (data.type === 'system_message') { // General system messages from server
                            console.log("System Message from Server:", data.text);
                            // Could display this in a global status area.
                        }
                         else {
                            console.warn("Received unknown message type from WebSocket:", data);
                        }
                    } catch (error) {
                        console.warn("Received non-JSON/malformed message from WebSocket:", event.data, error);
                        // Display as plain server message in current context if any, or log
                        if (targetRoomId && currentRoomId === targetRoomId) { // If in a room context
                           addRoomMessageToChat({type: 'server_message', text: `Raw: ${event.data}`});
                        }
                    }
                };

                socket.onclose = function(event) {
                    console.log(`WebSocket closed. Code: ${event.code}, Reason: '${event.reason}', Clean: ${event.wasClean}, TargetRoom: ${socket.targetRoomId}`);
                    const targetWasRoom = socket.targetRoomId; // Capture before socket is nulled

                    if (targetWasRoom) { // If this was a room-specific connection
                        statusDisplay.textContent = 'Disconnected from room';
                    } else { // General DM connection closed
                        console.log("General WebSocket connection for DMs closed.");
                    }
                    // Do not automatically call showAuthUI unless it's an unrecoverable global error.
                    // Client might try to reconnect or user might navigate.
                    if (event.code !== 1000 && event.code !== 1005) { // 1000=Normal, 1005=No status
                        const errorMsg = `WebSocket disconnected unexpectedly (Code: ${event.code}). Chat might be unavailable.`;
                        if(targetWasRoom && currentRoomId === targetWasRoom) {
                            addRoomMessageToChat({type: 'error', text: errorMsg});
                        } else if (!targetWasRoom && dmSection.classList.contains('active')) {
                            // If in DM view, maybe show error in DM area or alert
                            alert(errorMsg);
                        }
                    }
                    socket = null; // Important to allow re-connection attempts
                };

                socket.onerror = function(error) {
                    console.error(`WebSocket Error (TargetRoom: ${socket.targetRoomId}): `, error);
                    if (socket.targetRoomId) {
                        statusDisplay.textContent = 'Connection Error!';
                        addRoomMessageToChat({type: 'error', text: 'Error connecting to room chat.'});
                    } else {
                        alert('Error connecting to chat server for DMs.');
                    }
                };
            }

            // --- DM API Calls & Logic ---
            async function loadContacts() {
                try {
                    const response = await fetch('list_users.php');
                    const data = await response.json();
                    contactsListUL.innerHTML = '';
                    if (data.success && data.users) {
                        data.users.forEach(user => {
                            const li = document.createElement('li');
                            li.textContent = escapeHtml(user.username);
                            li.dataset.userId = user.id;
                            li.dataset.username = user.username;
                            li.addEventListener('click', () => {
                                selectDmContact(user.id, user.username);
                            });
                            contactsListUL.appendChild(li);
                        });
                    } else {
                        contactsListUL.innerHTML = '<li>Failed to load contacts.</li>';
                    }
                } catch (error) {
                    console.error('Error loading contacts:', error);
                    contactsListUL.innerHTML = '<li>Error loading contacts.</li>';
                }
            }

            async function selectDmContact(contactId, contactUsername) {
                if (currentDmContactId === contactId) return; // Already selected

                currentDmContactId = contactId;
                currentDmContactUsername = contactUsername;
                oldestDmMessageIdLoaded = null;
                isLoadingDmHistory = false;
                dmChatOutput.innerHTML = '';
                dmChatHeader.textContent = `Chat with ${escapeHtml(contactUsername)}`;
                dmInputArea.style.display = 'flex';

                // Highlight active contact
                document.querySelectorAll('#contacts-list li').forEach(li => li.classList.remove('active'));
                document.querySelector(`#contacts-list li[data-user-id='${contactId}']`)?.classList.add('active');

                await loadDirectMessageHistory(contactId);
            }

            async function loadDirectMessageHistory(contactId, loadOlder = false) {
                if (isLoadingDmHistory) return;
                if (loadOlder && oldestDmMessageIdLoaded === -1) return; // No more to load

                isLoadingDmHistory = true;
                // TODO: Add a "Load More DMs" button if desired, similar to rooms. For now, auto-load or initial fixed limit.

                let queryParams = `contact_user_id=${contactId}&limit=50`; // Load more DMs by default for now
                if (loadOlder && oldestDmMessageIdLoaded) {
                    queryParams += `&before_message_id=${oldestDmMessageIdLoaded}`;
                }

                try {
                    const response = await fetch(`get_direct_messages.php?${queryParams}`);
                    const data = await response.json();
                    if (data.success && data.messages) {
                        if (data.messages.length > 0) {
                            data.messages.forEach(msg => addDirectMessageToChat(msg, true)); // Prepend history
                            oldestDmMessageIdLoaded = data.messages[0].id; // Oldest of this batch
                        } else {
                            if (!loadOlder) dmChatOutput.innerHTML = '<div class="server-message">No messages yet.</div>';
                            oldestDmMessageIdLoaded = -1; // No more messages
                        }
                        // Auto-scroll to bottom after initial load
                        if (!loadOlder) dmChatOutput.scrollTop = dmChatOutput.scrollHeight;
                    } else {
                        dmChatOutput.innerHTML = `<div class="server-message">Error: ${data.message || "Could not load messages."}</div>`;
                    }
                } catch (error) {
                    console.error("Error loading DM history:", error);
                    dmChatOutput.innerHTML = '<div class="server-message">Error loading messages.</div>';
                } finally {
                    isLoadingDmHistory = false;
                }
            }

            dmSendButton.addEventListener('click', async () => {
                const messageText = dmMessageInput.value.trim();
                if (!messageText || !currentDmContactId) return;

                // Optimistically add to UI (optional, server will confirm via WS)
                // addDirectMessageToChat({ sender_user_id: currentUserId, sender_username: currentUsername, content: messageText, id: 'temp-' + Date.now() });

                // Send via WebSocket
                if (socket && socket.readyState === WebSocket.OPEN) {
                    const messagePayload = {
                        type: 'direct_message',
                        receiver_id: currentDmContactId,
                        text: messageText
                    };
                    socket.send(JSON.stringify(messagePayload));
                    dmMessageInput.value = '';
                } else {
                    alert("WebSocket not connected. Cannot send direct message.");
                    // Fallback: try to send via HTTP API anyway, but user won't get real-time update for receiver.
                    // await sendDirectMessageViaApi(currentDmContactId, messageText);
                }
            });

            dmMessageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    dmSendButton.click();
                }
            });

            // Helper to send DM via API (primarily for storage, WS handles real-time)
            // async function sendDirectMessageViaApi(receiverId, textContent) {
            //     try {
            //         const response = await fetch('send_direct_message.php', {
            //             method: 'POST',
            //             headers: { 'Content-Type': 'application/json' },
            //             body: JSON.stringify({ receiver_id: receiverId, content: textContent })
            //         });
            //         const data = await response.json();
            //         if (!data.success) {
            //             console.error("API failed to send DM:", data.message);
            //             // If optimistic add was done, might need to mark message as failed.
            //         }
            //         // Server will send WS message back to sender for confirmation if using that pattern.
            //     } catch (error) {
            //         console.error('Error sending DM via API:', error);
            //     }
            // }


            // --- Room API Calls & Related Logic ---
            async function loadRoomMessageHistory(roomId, loadOlder = false) { // Renamed from loadMessageHistory
                if (isLoadingRoomHistory) return;
                if (loadOlder && oldestRoomMessageIdLoaded === -1) {
                    loadMoreMessagesButton.style.display = 'none';
                    return;
                }

                isLoadingRoomHistory = true;
                loadMoreMessagesButton.textContent = 'Loading...';
                loadMoreMessagesButton.disabled = true;
                if(!loadOlder) loadMoreMessagesButton.style.display = 'none';

                let queryParams = `roomId=${roomId}&limit=20`;
                if (loadOlder && oldestRoomMessageIdLoaded) {
                    queryParams += `&before_message_id=${oldestRoomMessageIdLoaded}`;
                }

                try {
                    const response = await fetch(`get_room_messages.php?${queryParams}`);
                    const data = await response.json();

                    if (data.success && data.messages) {
                        if (data.messages.length > 0) {
                            const oldScrollHeight = chatOutput.scrollHeight; // Room chat output
                            const firstCurrentlyVisibleMessage = chatOutput.firstChild;

                            data.messages.forEach(msg => {
                                addRoomMessageToChat(msg, true); // Use new specific function
                            });

                            oldestRoomMessageIdLoaded = data.messages[0].id;

                            if (loadOlder) {
                                if(firstCurrentlyVisibleMessage) {
                                   chatOutput.scrollTop = firstCurrentlyVisibleMessage.offsetTop - chatOutput.offsetTop;
                                } else {
                                   chatOutput.scrollTop = chatOutput.scrollHeight - oldScrollHeight;
                                }
                            } else {
                                chatOutput.scrollTop = chatOutput.scrollHeight;
                            }

                            if (data.messages.length >= 20) {
                                loadMoreMessagesButton.style.display = 'block';
                            } else {
                                loadMoreMessagesButton.style.display = 'none';
                                oldestRoomMessageIdLoaded = -1;
                            }
                        } else {
                            if (!loadOlder) {
                                addRoomMessageToChat({type: 'server_message', text: "No messages in this room yet. Start the conversation!"});
                            } else {
                                 addRoomMessageToChat({type: 'server_message', text: "No more messages to load."}, true);
                            }
                            loadMoreMessagesButton.style.display = 'none';
                            oldestRoomMessageIdLoaded = -1;
                        }
                    } else {
                        addRoomMessageToChat({type: 'server_message', text: data.message || "Could not load room message history."}, loadOlder);
                        if(loadOlder) loadMoreMessagesButton.style.display = 'block';
                    }
                } catch (error) {
                    console.error("Error loading room message history:", error);
                    addRoomMessageToChat({type: 'server_message', text: "Error loading room message history."}, loadOlder);
                     if(loadOlder) loadMoreMessagesButton.style.display = 'block';
                } finally {
                    isLoadingRoomHistory = false;
                    loadMoreMessagesButton.textContent = 'Load More Messages';
                    loadMoreMessagesButton.disabled = false;
                    if (!loadOlder && oldestRoomMessageIdLoaded === -1) {
                        loadMoreMessagesButton.style.display = 'none';
                    }
                }
            }

            async function loadUserRooms() {
                try {
                    const response = await fetch('list_my_rooms.php');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    roomListUL.innerHTML = ''; // Clear existing list
                    if (data.success && data.rooms.length > 0) {
                        data.rooms.forEach(room => {
                            const li = document.createElement('li');
                            li.textContent = room.name;
                            li.dataset.roomId = room.id;
                            li.dataset.roomName = room.name;
                            li.dataset.creatorId = room.creator_user_id;

                            const creatorSpan = document.createElement('span');
                            creatorSpan.className = 'room-creator';
                            creatorSpan.textContent = `Creator: ${room.creator_username}`;
                            li.appendChild(creatorSpan);

                            li.addEventListener('click', () => {
                                showChatUI(currentUsername, room.id, room.name, room.creator_user_id);
                            });
                            roomListUL.appendChild(li);
                        });
                    } else if (data.success && data.rooms.length === 0) {
                        roomListUL.innerHTML = '<li>No rooms found. Create one!</li>';
                    } else {
                        setDashboardMessage(data.message || 'Could not load rooms.', true);
                    }
                } catch (error) {
                    console.error('Error loading rooms:', error);
                    setDashboardMessage('Error loading rooms. Check connection.', true);
                }
            }

            createRoomForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const roomName = newRoomNameInput.value.trim();
                if (!roomName) {
                    setDashboardMessage('Room name cannot be empty.', true);
                    return;
                }
                try {
                    const response = await fetch('create_room.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ roomName })
                    });
                    const data = await response.json();
                    if (data.success) {
                        setDashboardMessage(`Room '${data.roomName}' created!`, false);
                        newRoomNameInput.value = '';
                        await loadUserRooms(); // Refresh list
                    } else {
                        setDashboardMessage(data.message || 'Failed to create room.', true);
                    }
                } catch (error) {
                    console.error('Error creating room:', error);
                    setDashboardMessage('Error creating room.', true);
                }
            });

            // --- Member Management (Step 7) ---
            function updateMemberInviteAreaVisibility() {
                if (currentUserId && currentRoomCreatorId && parseInt(currentUserId) === parseInt(currentRoomCreatorId)) {
                    memberInviteArea.style.display = 'flex';
                    loadInviteCandidates(currentRoomId); // Load candidates when area becomes visible
                } else {
                    memberInviteArea.style.display = 'none';
                }
            }

            async function loadInviteCandidates(roomId) {
                if (!roomId) return;
                try {
                    const response = await fetch(`list_invite_candidates.php?roomId=${roomId}`);
                    const data = await response.json();
                    inviteUserSelect.innerHTML = '<option value="">Select user to invite...</option>'; // Clear and add default
                    if (data.success && data.users) {
                        if (data.users.length === 0) {
                            const option = document.createElement('option');
                            option.value = "";
                            option.textContent = "No new users to invite";
                            option.disabled = true;
                            inviteUserSelect.appendChild(option);
                        } else {
                            data.users.forEach(user => {
                                const option = document.createElement('option');
                                option.value = user.username; // API `invite_to_room.php` expects username
                                option.textContent = escapeHtml(user.username);
                                inviteUserSelect.appendChild(option);
                            });
                        }
                    } else {
                        setMemberInviteMessage(data.message || 'Could not load invite candidates.', true);
                    }
                } catch (error) {
                    console.error('Error loading invite candidates:', error);
                    setMemberInviteMessage('Error loading invite candidates.', true);
                    inviteUserSelect.innerHTML = '<option value="">Error loading users</option>';
                }
            }

            async function loadRoomMembers() {
                if (!currentRoomId) return;
                try {
                    const response = await fetch(`get_room_members.php?roomId=${currentRoomId}`);
                    const data = await response.json();
                    memberListUL.innerHTML = '';
                    if (data.success && data.members) {
                        data.members.forEach(member => {
                            const li = document.createElement('li');
                            li.textContent = escapeHtml(member.username) + (member.userId === currentUserId ? ' (You)' : '');

                            if (currentUserId === currentRoomCreatorId && member.userId !== currentUserId) {
                                const removeBtn = document.createElement('button');
                                removeBtn.className = 'remove-member-btn';
                                removeBtn.textContent = 'Remove';
                                removeBtn.dataset.userId = member.userId;
                                removeBtn.onclick = () => handleRemoveMember(member.userId, member.username);
                                li.appendChild(removeBtn);
                            }
                            memberListUL.appendChild(li);
                        });
                    } else {
                        memberListUL.innerHTML = '<li>Could not load members.</li>';
                    }
                } catch (error) {
                    console.error('Error loading room members:', error);
                    memberListUL.innerHTML = '<li>Error loading members.</li>';
                }
            }

            inviteForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const selectedUsername = inviteUserSelect.value;
                if (!selectedUsername) {
                    setMemberInviteMessage('Please select a user to invite.', true);
                    return;
                }
                try {
                    const response = await fetch('invite_to_room.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ roomId: currentRoomId, targetUsername: selectedUsername })
                    });
                    const data = await response.json();
                    if (data.success) {
                        setMemberInviteMessage(data.message || `User '${selectedUsername}' invited.`, false);
                        // inviteUserSelect.value = ''; // Reset select - done by loadInviteCandidates
                        await loadRoomMembers();      // Refresh member list
                        await loadInviteCandidates(currentRoomId); // Refresh invite candidates
                    } else {
                        setMemberInviteMessage(data.message || 'Failed to invite user.', true);
                    }
                } catch (error) {
                    console.error('Error inviting user:', error);
                    setMemberInviteMessage('Error inviting user.', true);
                }
            });

            async function handleRemoveMember(userIdToRemove, usernameToRemove) {
                if (!confirm(`Are you sure you want to remove ${usernameToRemove} from this room?`)) {
                    return;
                }
                try {
                    const response = await fetch('remove_from_room.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ roomId: currentRoomId, targetUserIdToRemove: userIdToRemove })
                    });
                    const data = await response.json();
                    if (data.success) {
                        setMemberInviteMessage(data.message || `User '${usernameToRemove}' removed.`, false);
                        await loadRoomMembers(); // Refresh member list
                    } else {
                        setMemberInviteMessage(data.message || 'Failed to remove user.', true);
                    }
                } catch (error) {
                    console.error('Error removing user:', error);
                    setMemberInviteMessage('Error removing user.', true);
                }
            }


            // --- Initial Setup & Auth Flow ---
            async function checkUserSession() {
                try {
                    const response = await fetch('check_session.php');
                    const data = await response.json();
                    if (data.loggedIn && data.username && data.userId) {
                        currentUserId = data.userId; // Store logged in user's ID
                        await showRoomDashboardUI(data.username);
                    } else {
                        showAuthUI();
                    }
                } catch (error) {
                    console.error("Error checking session:", error);
                    showAuthUI();
                    authMessage.textContent = "Error contacting server. Please try again later.";
                }
            }

            showRegisterBtn.addEventListener('click', () => {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                authTitle.textContent = 'Register';
                authMessage.textContent = '';
            });

            showLoginBtn.addEventListener('click', () => {
                registerForm.style.display = 'none';
                loginForm.style.display = 'block';
                authTitle.textContent = 'Login';
                authMessage.textContent = '';
            });

            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                authMessage.textContent = '';

                try {
                    const response = await fetch('login.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await response.json();
                    if (data.success && data.username && data.userId) {
                        currentUserId = data.userId; // Store logged in user's ID
                        await showRoomDashboardUI(data.username);
                    } else {
                        authMessage.textContent = data.message || 'Login failed.';
                    }
                } catch (error) {
                    console.error("Login error:", error);
                    authMessage.textContent = "Error during login. Please try again.";
                }
            });

            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('register-username').value;
                const password = document.getElementById('register-password').value;
                authMessage.textContent = '';

                try {
                    const response = await fetch('register.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await response.json();
                    if (data.success) {
                        authMessage.textContent = (data.message || "Registration successful.") + " Please login.";
                        showLoginBtn.click();
                    } else {
                        authMessage.textContent = data.message || 'Registration failed.';
                    }
                } catch (error) {
                    console.error("Registration error:", error);
                    authMessage.textContent = "Error during registration. Please try again.";
                }
            });

            backToDashboardButton.addEventListener('click', async () => {
                if (socket) {
                    socket.close(1000, "Navigating away");
                    socket = null;
                }
                currentRoomId = null;
                currentRoomCreatorId = null;
                memberInviteArea.style.display = 'none'; // Hide member area
                inviteUserSelect.innerHTML = '<option value="">Select user to invite...</option>'; // Clear invite select

                // Clear notifications when going back to dashboard
                notifications = [];
                unreadNotificationCount = 0;
                renderNotifications();
                notificationPopup.style.display = 'none';

                await showRoomDashboardUI(currentUsername);
            });

            async function handleLogout(callApi = true) {
                if (callApi) {
                    try {
                        await fetch('logout.php', { method: 'POST' });
                    } catch (error) {
                        console.error("Logout API call failed:", error);
                    }
                }

                if (socket) {
                    socket.close(1000, "User logged out");
                    socket = null;
                }
                currentUsername = null;
                currentUserId = null;
                currentRoomId = null;
                currentRoomCreatorId = null;
                chatOutput.innerHTML = '';
                memberListUL.innerHTML = '';
                roomListUL.innerHTML = '';
                showAuthUI();
                document.getElementById('login-username').value = ''; // Clear login form
                document.getElementById('login-password').value = '';
            }

            logoutButton.addEventListener('click', () => handleLogout());

            sendButton.onclick = function() {
                const messageText = messageInput.value.trim();
                if (messageText !== '' && socket && socket.readyState === WebSocket.OPEN && currentRoomId) {
                    const messagePayload = {
                        type: 'room_message',
                        text: messageText
                        // roomId is implicit in the server based on the connection's currentRoomId context
                    };
                    socket.send(JSON.stringify(messagePayload));
                    messageInput.value = '';
                } else if (!socket || socket.readyState !== WebSocket.OPEN) {
                    addRoomMessageToChat({type: 'error', text: "Not connected to room chat. Please select a room or try logging in again."});
                } else if (!currentRoomId) {
                     addRoomMessageToChat({type: 'error', text: "No room selected to send message."});
                }
            };

            loadMoreMessagesButton.addEventListener('click', () => {
                if (currentRoomId && !isLoadingRoomHistory) { // Ensure not already loading & use correct flag
                    loadRoomMessageHistory(currentRoomId, true); // Use correct history function
                }
            });

            chatOutput.addEventListener('scroll', () => {
                // Load more when scrolled to the top and button is visible (meaning more might be available)
                if (chatOutput.scrollTop === 0 && !isLoadingRoomHistory && oldestRoomMessageIdLoaded !== -1 && loadMoreMessagesButton.style.display === 'block') {
                    console.log("Scrolled to top, loading more room messages...");
                    loadRoomMessageHistory(currentRoomId, true); // Use correct history function and flags
                }
            });

            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendButton.click();
                }
            });

            // Initial Load
            checkUserSession();

            // --- Main App Navigation Event Listeners ---
            navDmButton.addEventListener('click', () => {
                if (!navDmButton.classList.contains('active')) {
                    showDmUI();
                }
            });

            navRoomsButton.addEventListener('click', () => {
                if (!navRoomsButton.classList.contains('active')) {
                    showRoomsUI();
                }
            });
        });
    </script>
</body>
</html>
