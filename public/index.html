<!DOCTYPE html>
<html>
<head>
    <title>Chat App</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; display: flex; justify-content: center; align-items: center; min-height: 100vh; font-size: 14px; }
        .container { width: 100%; max-width: 700px; margin: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }

        .header-bar { background-color: #007bff; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .header-bar #user-info { font-weight: bold; }
        .header-bar #logout-button { background-color: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .header-bar #logout-button:hover { background-color: #c82333; }

        /* Auth Forms */
        #auth-container { padding: 30px; }
        #auth-container h2 { text-align: center; margin-bottom: 20px; color: #333; }
        .auth-form { display: none; }
        .auth-form input[type="text"], .auth-form input[type="password"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .auth-form button[type="submit"] { width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .auth-form button[type="submit"]:hover { background-color: #0056b3; }
        .toggle-form { text-align: center; margin-top: 15px; }
        .toggle-form button { background: none; border: none; color: #007bff; cursor: pointer; text-decoration: underline; font-size: 0.9em; }
        #auth-message { text-align: center; margin-bottom: 15px; color: red; min-height: 1.2em; }

        /* Room Dashboard */
        #room-dashboard { padding: 20px; display: none; }
        #room-dashboard h2 { margin-top: 0; color: #333; text-align: center; }
        #room-dashboard h3 { margin-top: 20px; margin-bottom: 10px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        #create-room-form input[type="text"] { width: calc(70% - 12px); padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px;}
        #create-room-form button { padding: 8px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #create-room-form button:hover { background-color: #218838; }
        #room-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
        #room-list li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        #room-list li:last-child { border-bottom: none; }
        #room-list li:hover { background-color: #f0f0f0; }
        #room-list .room-creator { font-size: 0.8em; color: #777; }
        #dashboard-message { text-align: center; margin-top: 10px; color: #555; }


        /* Chat Area */
        #chat-wrapper { display: none; flex-grow: 1; flex-direction: column; }
        #chat-header { background-color: #6c757d; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        #chat-header #current-room-display { font-weight: bold; }
        #chat-header #back-to-dashboard { background-color: #ffc107; color: #212529; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        #chat-header #back-to-dashboard:hover { background-color: #e0a800; }

        #chat-content-wrapper { display: flex; flex-grow: 1; overflow: hidden; }

        #chat-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; /* For load more button */ }
        #load-more-messages { display: none; /* Hidden by default */ width: auto; margin: 10px auto 0px auto; padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; text-align: center;}
        #load-more-messages:hover { background-color: #5a6268; }

        #chat-output { /* height: 300px; Adjusted for member list */ overflow-y: auto; padding: 15px; border-bottom: 1px solid #eee; flex-grow: 1;}
        .message { margin-bottom: 12px; line-height: 1.4; }
        .message .sender { font-weight: bold; color: #007bff; }
        .message .text { margin-left: 8px; color: #333; word-wrap: break-word; }
        .server-message { font-style: italic; color: #6c757d; text-align: center; margin-bottom: 10px; font-size: 0.9em;}
        #input-area { display: flex; padding: 15px; border-top: 1px solid #eee; background-color: #f8f9fa; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; }
        #send-button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #send-button:hover { background-color: #0056b3; }
        #status { padding: 8px 15px; background-color: #e9ecef; text-align: center; font-size: 0.85em; color: #495057; border-bottom: 1px solid #ddd;}

        /* Member List & Invite Area */
        #member-invite-area { width: 200px; border-left: 1px solid #ddd; padding: 15px; background-color: #f8f9fa; display: flex; flex-direction: column; }
        #member-invite-area h4 { margin-top: 0; margin-bottom: 10px; font-size: 1.1em; color: #333; }
        #member-list { list-style: none; padding: 0; margin-bottom: 15px; max-height: 150px; overflow-y: auto; }
        #member-list li { padding: 5px 0; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        #member-list .remove-member-btn { background: none; border: none; color: #dc3545; cursor: pointer; font-size: 0.8em; padding: 2px 5px;}
        #member-list .remove-member-btn:hover { text-decoration: underline; }

        /* #invite-form input[type="text"] { width: calc(100% - 18px); padding: 6px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.9em;} */ /* Replaced by select */
        #invite-form select#invite-user-select { /* Style already applied inline, but can be centralized here */ }
        #invite-form button { width: 100%; padding: 6px; background-color: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.9em;}
        #invite-form button:hover { background-color: #138496; }
        #member-invite-message { font-size: 0.8em; color: green; margin-top: 5px; min-height: 1em;}

    </style>
</head>
<body>
    <div class="container">
        <div class="header-bar" style="display: none;" id="main-header-bar">
            <span id="user-info"></span>
            <button id="logout-button">Logout</button>
        </div>

        <!-- Authentication Forms -->
        <div id="auth-container">
            <h2 id="auth-title">Login</h2>
            <div id="auth-message"></div>
            <form id="login-form" class="auth-form">
                <input type="text" id="login-username" placeholder="Username" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit">Login</button>
                <div class="toggle-form">
                    Don't have an account? <button type="button" id="show-register">Register here</button>
                </div>
            </form>
            <form id="register-form" class="auth-form">
                <input type="text" id="register-username" placeholder="Username" required>
                <input type="password" id="register-password" placeholder="Password" required>
                <button type="submit">Register</button>
                <div class="toggle-form">
                    Already have an account? <button type="button" id="show-login">Login here</button>
                </div>
            </form>
        </div>

        <!-- Room Dashboard -->
        <div id="room-dashboard">
            <h2>Room Dashboard</h2>
            <div id="dashboard-message"></div>
            <form id="create-room-form">
                <h3>Create New Room</h3>
                <input type="text" id="new-room-name" placeholder="Enter room name" required>
                <button type="submit">Create Room</button>
            </form>
            <h3>Your Rooms</h3>
            <ul id="room-list">
                <!-- Room items will be populated by JS -->
            </ul>
        </div>

        <!-- Chat Application -->
        <div id="chat-wrapper">
            <div id="chat-header">
                <span id="current-room-display"></span>
                <button id="back-to-dashboard">Back to Rooms</button>
            </div>
            <div id="status">Connecting...</div>
            <div id="chat-content-wrapper">
                <div id="chat-container">
                    <button id="load-more-messages">Load More Messages</button>
                    <div id="chat-output"></div>
                    <div id="input-area">
                        <input type="text" id="message-input" placeholder="Type your message...">
                        <button id="send-button">Send</button>
                    </div>
                </div>
                <div id="member-invite-area" style="display: none;"> <!-- Initially hidden, shown if creator -->
                    <h4>Members</h4>
                    <ul id="member-list"></ul>
                    <div id="member-invite-message"></div>
                    <form id="invite-form">
                        <h4>Invite User</h4>
                        <select id="invite-user-select" required style="width: 100%; padding: 6px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.9em; background-color: white;">
                            <option value="">Select user to invite...</option>
                        </select>
                        <button type="submit">Invite</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // UI Elements - Auth
            const authContainer = document.getElementById('auth-container');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const authMessage = document.getElementById('auth-message');
            const authTitle = document.getElementById('auth-title');
            const showRegisterBtn = document.getElementById('show-register');
            const showLoginBtn = document.getElementById('show-login');

            // UI Elements - Main Header
            const mainHeaderBar = document.getElementById('main-header-bar');
            const userInfoDisplay = document.getElementById('user-info');
            const logoutButton = document.getElementById('logout-button');

            // UI Elements - Room Dashboard
            const roomDashboard = document.getElementById('room-dashboard');
            const createRoomForm = document.getElementById('create-room-form');
            const newRoomNameInput = document.getElementById('new-room-name');
            const roomListUL = document.getElementById('room-list');
            const dashboardMessage = document.getElementById('dashboard-message');

            // UI Elements - Chat
            const chatWrapper = document.getElementById('chat-wrapper');
            const chatHeader = document.getElementById('chat-header');
            const currentRoomDisplay = document.getElementById('current-room-display');
            const backToDashboardButton = document.getElementById('back-to-dashboard');
            const statusDisplay = document.getElementById('status');
            const chatOutput = document.getElementById('chat-output'); // This is the scrollable message area
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const loadMoreMessagesButton = document.getElementById('load-more-messages');


            // UI Elements - Member/Invite Area
            const memberInviteArea = document.getElementById('member-invite-area');
            const memberListUL = document.getElementById('member-list');
            const inviteForm = document.getElementById('invite-form');
            const inviteUserSelect = document.getElementById('invite-user-select'); // Changed from inviteUsernameInput
            const memberInviteMessage = document.getElementById('member-invite-message');


            let socket = null;
            let currentUsername = null;
            let currentUserId = null;
            let currentRoomId = null;
            let currentRoomCreatorId = null;
            let oldestMessageIdLoaded = null; // Track the oldest message ID loaded for pagination
            let isLoadingHistory = false; // Flag to prevent multiple history loads

            function escapeHtml(unsafe) {
                return unsafe
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
            }

            function addMessageToChat(data, isHistory = false) {
                // data expected for history: { id, senderUsername, content, messageType, sentAt, userId (sender's ID) }
                // data expected for live WebSocket: { type: 'message'/'server_message'/'error', sender: '...', text: '...' }

                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message');
                if (data.id) { // History messages will have an ID
                    messageDiv.dataset.messageId = data.id;
                }

                let SENDER_TEXT = data.senderUsername || data.sender;
                let CONTENT_TEXT = data.content || data.text;
                let MESSAGE_TYPE = data.messageType || data.type;

                const isMe = SENDER_TEXT === currentUsername;

                if (MESSAGE_TYPE === 'server_message' || MESSAGE_TYPE === 'error') {
                    messageDiv.classList.add('server-message');
                    messageDiv.textContent = escapeHtml(CONTENT_TEXT);
                } else if (MESSAGE_TYPE === 'system_join' || MESSAGE_TYPE === 'system_leave') {
                    messageDiv.classList.add('server-message');
                    try {
                        // Assuming system message content is JSON like: {"username": "User", "action": "join/leave", "text": "User X has joined/left..."}
                        const parsedContent = JSON.parse(CONTENT_TEXT);
                        messageDiv.textContent = escapeHtml(parsedContent.text || CONTENT_TEXT); // Use parsed text if available
                    } catch (e) {
                        messageDiv.textContent = escapeHtml(CONTENT_TEXT); // Fallback if content is not JSON or no 'text' field
                    }
                } else { // Regular user text messages
                    const senderSpan = document.createElement('span');
                    senderSpan.classList.add('sender');
                    senderSpan.textContent = escapeHtml(SENDER_TEXT) + (isMe ? " (Me)" : "") + ": ";

                    const textSpan = document.createElement('span');
                    textSpan.classList.add('text');
                    textSpan.textContent = escapeHtml(CONTENT_TEXT);

                    messageDiv.appendChild(senderSpan);
                    messageDiv.appendChild(textSpan);
                }

                if (isHistory) {
                    chatOutput.insertBefore(messageDiv, chatOutput.firstChild); // Prepend for history
                } else {
                    chatOutput.appendChild(messageDiv); // Append for live messages
                    chatOutput.scrollTop = chatOutput.scrollHeight; // Auto-scroll for new messages
                }
            }

            function setDashboardMessage(message, isError = false) {
                dashboardMessage.textContent = message;
                dashboardMessage.style.color = isError ? 'red' : 'green';
                setTimeout(() => dashboardMessage.textContent = '', 3000);
            }

            function setMemberInviteMessage(message, isError = false) {
                memberInviteMessage.textContent = message;
                memberInviteMessage.style.color = isError ? 'red' : 'green';
                setTimeout(() => memberInviteMessage.textContent = '', 3000);
            }


            // --- UI State Management ---
            function showAuthUI() {
                authContainer.style.display = 'block';
                roomDashboard.style.display = 'none';
                chatWrapper.style.display = 'none';
                mainHeaderBar.style.display = 'none';
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                authTitle.textContent = 'Login';
                authMessage.textContent = '';
            }

            async function showRoomDashboardUI(username) {
                currentUsername = username; // Set from login or session check
                authContainer.style.display = 'none';
                chatWrapper.style.display = 'none';
                roomDashboard.style.display = 'block';
                mainHeaderBar.style.display = 'flex';
                userInfoDisplay.textContent = `Logged in as: ${username}`;
                await loadUserRooms();
            }

            async function showChatUI(username, roomId, roomName, roomCreatorId) {
                currentUsername = username;
                currentRoomId = roomId;
                currentRoomCreatorId = roomCreatorId;
                oldestMessageIdLoaded = null;
                isLoadingHistory = false;
                chatOutput.innerHTML = ''; // Clear previous room's messages
                loadMoreMessagesButton.style.display = 'none'; // Hide load more button for new room initially

                authContainer.style.display = 'none';
                roomDashboard.style.display = 'none';
                chatWrapper.style.display = 'flex';
                mainHeaderBar.style.display = 'flex';

                currentRoomDisplay.textContent = `Room: ${escapeHtml(roomName)}`;
                statusDisplay.textContent = 'Loading history...';

                await loadMessageHistory(roomId); // Initial load of messages

                statusDisplay.textContent = 'Connecting to chat...'; // Update status before WebSocket connect
                connectWebSocket(username, roomId);
                updateMemberInviteAreaVisibility();
                if (memberInviteArea.style.display !== 'none') {
                    // loadRoomMembers and loadInviteCandidates are called within updateMemberInviteAreaVisibility if needed
                    // or can be called here again if a specific order is required after WebSocket connection.
                    // For now, updateMemberInviteAreaVisibility handles it.
                }
            }

            // --- WebSocket Logic (Step 6) ---
            function connectWebSocket(username, roomId) {
                if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
                    console.log("WebSocket closing existing connection before opening new one.");
                    socket.close();
                }

                socket = new WebSocket(`ws://localhost:8080?username=${encodeURIComponent(username)}&roomId=${roomId}`);

                socket.onopen = function(e) {
                    statusDisplay.textContent = 'Connected';
                    console.log(`Connection established to room ${roomId}!`);
                    // Server join messages are now stored, so history will show them.
                    // Client-only confirmation for WebSocket connection:
                    addMessageToChat({type: 'server_message', text: `WebSocket connected to room '${escapeHtml(currentRoomDisplay.textContent.replace("Room: ",""))}'.`});
                };

                socket.onmessage = function(event) {
                    console.log(`Data received from server: ${event.data}`);
                    try {
                        const data = JSON.parse(event.data);
                        // Expecting live messages to have: { type, sender, text, roomId }
                        // System messages from server (like join/leave if not handled by history) might be 'server_message'
                        addMessageToChat(data); // Let addMessageToChat handle different types

                        // If a join/leave type of server_message, and current user is creator, refresh member list
                        // This is now primarily handled by history, but can be a fallback or for immediate updates.
                        // The Chat.php currently sends simple text for join/leave broadcasts.
                        if (data.type === 'server_message' && (data.text.includes('has joined') || data.text.includes('has left'))) {
                            if (parseInt(currentUserId) === parseInt(currentRoomCreatorId)) {
                                loadRoomMembers();
                                loadInviteCandidates(currentRoomId); // Also refresh candidates
                            }
                        }
                    } catch (error) {
                        console.warn("Received non-JSON message or malformed JSON from WebSocket:", event.data, error);
                        addMessageToChat({type: 'server_message', text: event.data}); // Display as plain server message
                    }
                };

                socket.onclose = function(event) {
                    statusDisplay.textContent = 'Disconnected';
                    let reason = event.reason || 'Connection closed';
                    if(event.code === 1000 && event.reason === "User logged out") {
                        reason = "You have been logged out."; // No chat message needed, handled by logout UI change
                    } else if(event.code === 1000 && event.reason === "Navigating away") {
                        reason = "Navigated away from chat."; // No chat message needed
                    } else {
                        // For other closures, display the message in chat
                        addMessageToChat({type: 'server_message', text: `Disconnected: ${reason} (Code: ${event.code})`});
                    }
                    console.log(`WebSocket closed: Code=${event.code}, Reason=${reason}, WasClean=${event.wasClean}`);

                     // If not a deliberate clean closure initiated by client's UI actions (logout/navigating away)
                    if (!(event.code === 1000 && (event.reason === "User logged out" || event.reason === "Navigating away"))) {
                         authMessage.textContent = `Connection issue: ${reason}. Please login or select a room again.`;
                         // Transition to a state where user can re-initiate. Forcing full logout might be too much if session is fine.
                         // For now, simplest is to go to auth UI.
                         showAuthUI();
                    }
                    socket = null;
                };

                socket.onerror = function(error) {
                    statusDisplay.textContent = 'Connection Error!';
                    console.error(`WebSocket Error: `, error);
                    addMessageToChat('server', null, `Error: Could not connect to the chat server.`);
                };
            }

            // --- API Calls & Related Logic (Step 5 & 7) ---

            async function loadMessageHistory(roomId, loadOlder = false) {
                if (isLoadingHistory) return;
                if (loadOlder && oldestMessageIdLoaded === -1) { // -1 signifies no more messages
                    loadMoreMessagesButton.style.display = 'none'; // Should already be hidden but ensure
                    return;
                }

                isLoadingHistory = true;
                loadMoreMessagesButton.textContent = 'Loading...';
                loadMoreMessagesButton.disabled = true;
                if(!loadOlder) loadMoreMessagesButton.style.display = 'none'; // Hide unless it's a "load older" specific request initially

                let queryParams = `roomId=${roomId}&limit=20`; // Fetch 20 messages at a time
                if (loadOlder && oldestMessageIdLoaded) {
                    queryParams += `&before_message_id=${oldestMessageIdLoaded}`;
                }

                try {
                    const response = await fetch(`get_room_messages.php?${queryParams}`);
                    const data = await response.json();

                    if (data.success && data.messages) {
                        if (data.messages.length > 0) {
                            const oldScrollHeight = chatOutput.scrollHeight;
                            const firstCurrentlyVisibleMessage = chatOutput.firstChild;

                            data.messages.forEach(msg => {
                                // API returns { id, roomId, userId, senderUsername, messageType, content, metadata, sentAt }
                                addMessageToChat(msg, true); // true for isHistory (prepend)
                            });

                            oldestMessageIdLoaded = data.messages[0].id; // First message in (originally reversed by API) array is oldest of this batch

                            if (loadOlder) {
                                // Try to maintain scroll position relative to the old top message
                                if(firstCurrentlyVisibleMessage) {
                                   chatOutput.scrollTop = firstCurrentlyVisibleMessage.offsetTop - chatOutput.offsetTop;
                                } else {
                                   chatOutput.scrollTop = chatOutput.scrollHeight - oldScrollHeight;
                                }
                            } else {
                                // Scroll to bottom for initial load
                                chatOutput.scrollTop = chatOutput.scrollHeight;
                            }

                            // Show "Load More" button only if we received a full batch of messages
                            if (data.messages.length >= 20) {
                                loadMoreMessagesButton.style.display = 'block';
                            } else {
                                loadMoreMessagesButton.style.display = 'none';
                                oldestMessageIdLoaded = -1; // Mark that we've reached the end
                            }
                        } else { // No messages returned
                            if (loadOlder) {
                                addMessageToChat({type: 'server', text: "No more messages to load."}, true);
                            } else {
                                // Initial load and no messages in room yet
                                addMessageToChat({type: 'server', text: "No messages in this room yet. Start the conversation!"});
                            }
                            loadMoreMessagesButton.style.display = 'none';
                            oldestMessageIdLoaded = -1;
                        }
                    } else {
                        addMessageToChat({type: 'server', text: data.message || "Could not load message history."}, loadOlder);
                        if(loadOlder) loadMoreMessagesButton.style.display = 'block'; // Allow retry if it was a "load older" attempt
                    }
                } catch (error) {
                    console.error("Error loading message history:", error);
                    addMessageToChat({type: 'server', text: "Error loading message history."}, loadOlder);
                     if(loadOlder) loadMoreMessagesButton.style.display = 'block'; // Allow retry
                } finally {
                    isLoadingHistory = false;
                    loadMoreMessagesButton.textContent = 'Load More Messages';
                    loadMoreMessagesButton.disabled = false;
                    // If initial load and no messages, ensure button is hidden
                    if (!loadOlder && oldestMessageIdLoaded === -1) {
                        loadMoreMessagesButton.style.display = 'none';
                    }
                }
            }

            async function loadUserRooms() {
                try {
                    const response = await fetch('list_my_rooms.php');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    roomListUL.innerHTML = ''; // Clear existing list
                    if (data.success && data.rooms.length > 0) {
                        data.rooms.forEach(room => {
                            const li = document.createElement('li');
                            li.textContent = room.name;
                            li.dataset.roomId = room.id;
                            li.dataset.roomName = room.name;
                            li.dataset.creatorId = room.creator_user_id;

                            const creatorSpan = document.createElement('span');
                            creatorSpan.className = 'room-creator';
                            creatorSpan.textContent = `Creator: ${room.creator_username}`;
                            li.appendChild(creatorSpan);

                            li.addEventListener('click', () => {
                                showChatUI(currentUsername, room.id, room.name, room.creator_user_id);
                            });
                            roomListUL.appendChild(li);
                        });
                    } else if (data.success && data.rooms.length === 0) {
                        roomListUL.innerHTML = '<li>No rooms found. Create one!</li>';
                    } else {
                        setDashboardMessage(data.message || 'Could not load rooms.', true);
                    }
                } catch (error) {
                    console.error('Error loading rooms:', error);
                    setDashboardMessage('Error loading rooms. Check connection.', true);
                }
            }

            createRoomForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const roomName = newRoomNameInput.value.trim();
                if (!roomName) {
                    setDashboardMessage('Room name cannot be empty.', true);
                    return;
                }
                try {
                    const response = await fetch('create_room.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ roomName })
                    });
                    const data = await response.json();
                    if (data.success) {
                        setDashboardMessage(`Room '${data.roomName}' created!`, false);
                        newRoomNameInput.value = '';
                        await loadUserRooms(); // Refresh list
                    } else {
                        setDashboardMessage(data.message || 'Failed to create room.', true);
                    }
                } catch (error) {
                    console.error('Error creating room:', error);
                    setDashboardMessage('Error creating room.', true);
                }
            });

            // --- Member Management (Step 7) ---
            function updateMemberInviteAreaVisibility() {
                if (currentUserId && currentRoomCreatorId && parseInt(currentUserId) === parseInt(currentRoomCreatorId)) {
                    memberInviteArea.style.display = 'flex';
                    loadInviteCandidates(currentRoomId); // Load candidates when area becomes visible
                } else {
                    memberInviteArea.style.display = 'none';
                }
            }

            async function loadInviteCandidates(roomId) {
                if (!roomId) return;
                try {
                    const response = await fetch(`list_invite_candidates.php?roomId=${roomId}`);
                    const data = await response.json();
                    inviteUserSelect.innerHTML = '<option value="">Select user to invite...</option>'; // Clear and add default
                    if (data.success && data.users) {
                        if (data.users.length === 0) {
                            const option = document.createElement('option');
                            option.value = "";
                            option.textContent = "No new users to invite";
                            option.disabled = true;
                            inviteUserSelect.appendChild(option);
                        } else {
                            data.users.forEach(user => {
                                const option = document.createElement('option');
                                option.value = user.username; // API `invite_to_room.php` expects username
                                option.textContent = escapeHtml(user.username);
                                inviteUserSelect.appendChild(option);
                            });
                        }
                    } else {
                        setMemberInviteMessage(data.message || 'Could not load invite candidates.', true);
                    }
                } catch (error) {
                    console.error('Error loading invite candidates:', error);
                    setMemberInviteMessage('Error loading invite candidates.', true);
                    inviteUserSelect.innerHTML = '<option value="">Error loading users</option>';
                }
            }

            async function loadRoomMembers() {
                if (!currentRoomId) return;
                try {
                    const response = await fetch(`get_room_members.php?roomId=${currentRoomId}`);
                    const data = await response.json();
                    memberListUL.innerHTML = '';
                    if (data.success && data.members) {
                        data.members.forEach(member => {
                            const li = document.createElement('li');
                            li.textContent = escapeHtml(member.username) + (member.userId === currentUserId ? ' (You)' : '');

                            if (currentUserId === currentRoomCreatorId && member.userId !== currentUserId) {
                                const removeBtn = document.createElement('button');
                                removeBtn.className = 'remove-member-btn';
                                removeBtn.textContent = 'Remove';
                                removeBtn.dataset.userId = member.userId;
                                removeBtn.onclick = () => handleRemoveMember(member.userId, member.username);
                                li.appendChild(removeBtn);
                            }
                            memberListUL.appendChild(li);
                        });
                    } else {
                        memberListUL.innerHTML = '<li>Could not load members.</li>';
                    }
                } catch (error) {
                    console.error('Error loading room members:', error);
                    memberListUL.innerHTML = '<li>Error loading members.</li>';
                }
            }

            inviteForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const selectedUsername = inviteUserSelect.value;
                if (!selectedUsername) {
                    setMemberInviteMessage('Please select a user to invite.', true);
                    return;
                }
                try {
                    const response = await fetch('invite_to_room.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ roomId: currentRoomId, targetUsername: selectedUsername })
                    });
                    const data = await response.json();
                    if (data.success) {
                        setMemberInviteMessage(data.message || `User '${selectedUsername}' invited.`, false);
                        // inviteUserSelect.value = ''; // Reset select - done by loadInviteCandidates
                        await loadRoomMembers();      // Refresh member list
                        await loadInviteCandidates(currentRoomId); // Refresh invite candidates
                    } else {
                        setMemberInviteMessage(data.message || 'Failed to invite user.', true);
                    }
                } catch (error) {
                    console.error('Error inviting user:', error);
                    setMemberInviteMessage('Error inviting user.', true);
                }
            });

            async function handleRemoveMember(userIdToRemove, usernameToRemove) {
                if (!confirm(`Are you sure you want to remove ${usernameToRemove} from this room?`)) {
                    return;
                }
                try {
                    const response = await fetch('remove_from_room.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ roomId: currentRoomId, targetUserIdToRemove: userIdToRemove })
                    });
                    const data = await response.json();
                    if (data.success) {
                        setMemberInviteMessage(data.message || `User '${usernameToRemove}' removed.`, false);
                        await loadRoomMembers(); // Refresh member list
                    } else {
                        setMemberInviteMessage(data.message || 'Failed to remove user.', true);
                    }
                } catch (error) {
                    console.error('Error removing user:', error);
                    setMemberInviteMessage('Error removing user.', true);
                }
            }


            // --- Initial Setup & Auth Flow ---
            async function checkUserSession() {
                try {
                    const response = await fetch('check_session.php');
                    const data = await response.json();
                    if (data.loggedIn && data.username && data.userId) {
                        currentUserId = data.userId; // Store logged in user's ID
                        await showRoomDashboardUI(data.username);
                    } else {
                        showAuthUI();
                    }
                } catch (error) {
                    console.error("Error checking session:", error);
                    showAuthUI();
                    authMessage.textContent = "Error contacting server. Please try again later.";
                }
            }

            showRegisterBtn.addEventListener('click', () => {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                authTitle.textContent = 'Register';
                authMessage.textContent = '';
            });

            showLoginBtn.addEventListener('click', () => {
                registerForm.style.display = 'none';
                loginForm.style.display = 'block';
                authTitle.textContent = 'Login';
                authMessage.textContent = '';
            });

            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                authMessage.textContent = '';

                try {
                    const response = await fetch('login.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await response.json();
                    if (data.success && data.username && data.userId) {
                        currentUserId = data.userId; // Store logged in user's ID
                        await showRoomDashboardUI(data.username);
                    } else {
                        authMessage.textContent = data.message || 'Login failed.';
                    }
                } catch (error) {
                    console.error("Login error:", error);
                    authMessage.textContent = "Error during login. Please try again.";
                }
            });

            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('register-username').value;
                const password = document.getElementById('register-password').value;
                authMessage.textContent = '';

                try {
                    const response = await fetch('register.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await response.json();
                    if (data.success) {
                        authMessage.textContent = (data.message || "Registration successful.") + " Please login.";
                        showLoginBtn.click();
                    } else {
                        authMessage.textContent = data.message || 'Registration failed.';
                    }
                } catch (error) {
                    console.error("Registration error:", error);
                    authMessage.textContent = "Error during registration. Please try again.";
                }
            });

            backToDashboardButton.addEventListener('click', async () => {
                if (socket) {
                    socket.close(1000, "Navigating away");
                    socket = null;
                }
                currentRoomId = null;
                currentRoomCreatorId = null;
                memberInviteArea.style.display = 'none'; // Hide member area
                inviteUserSelect.innerHTML = '<option value="">Select user to invite...</option>'; // Clear invite select
                await showRoomDashboardUI(currentUsername);
            });

            async function handleLogout(callApi = true) {
                if (callApi) {
                    try {
                        await fetch('logout.php', { method: 'POST' });
                    } catch (error) {
                        console.error("Logout API call failed:", error);
                    }
                }

                if (socket) {
                    socket.close(1000, "User logged out");
                    socket = null;
                }
                currentUsername = null;
                currentUserId = null;
                currentRoomId = null;
                currentRoomCreatorId = null;
                chatOutput.innerHTML = '';
                memberListUL.innerHTML = '';
                roomListUL.innerHTML = '';
                showAuthUI();
                document.getElementById('login-username').value = ''; // Clear login form
                document.getElementById('login-password').value = '';
            }

            logoutButton.addEventListener('click', () => handleLogout());

            sendButton.onclick = function() {
                const message = messageInput.value;
                if (message.trim() !== '' && socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(message); // Server now expects plain text for msg
                    messageInput.value = '';
                } else if (!socket || socket.readyState !== WebSocket.OPEN) {
                    addMessageToChat('server', null, "Not connected. Please select a room or try logging in again.");
                }
            };

            loadMoreMessagesButton.addEventListener('click', () => {
                if (currentRoomId && !isLoadingHistory) { // Ensure not already loading
                    loadMessageHistory(currentRoomId, true);
                }
            });

            chatOutput.addEventListener('scroll', () => {
                // Load more when scrolled to the top and button is visible (meaning more might be available)
                if (chatOutput.scrollTop === 0 && !isLoadingHistory && oldestMessageIdLoaded !== -1 && loadMoreMessagesButton.style.display === 'block') {
                    console.log("Scrolled to top, loading more messages...");
                    loadMessageHistory(currentRoomId, true);
                }
            });

            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendButton.click();
                }
            });

            // Initial Load
            checkUserSession();
        });
    </script>
</body>
</html>
