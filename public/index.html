<!DOCTYPE html>
<html>
<head>
    <title>Chat App</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; display: flex; flex-direction: column; align-items: center; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); width: 100%; max-width: 600px; margin-bottom:20px;}
        #auth-container, #chat-app-container { display: none; /* Hidden by default, shown by JS */}
        #chat-output { height: 300px; overflow-y: auto; padding: 10px; border: 1px solid #eee; margin-bottom: 10px; background-color: #f9f9f9; }
        .message { margin-bottom: 10px; padding: 8px; border-radius: 4px; }
        .message .sender { font-weight: bold; color: #007bff; }
        .message .text { margin-left: 5px; color: #333; }
        .my-message { background-color: #d1e7fd; text-align: right;}
        .other-message { background-color: #e9ecef; }
        .server-message { font-style: italic; color: #6c757d; text-align: center; margin-bottom: 10px; font-size:0.9em; }
        #input-area { display: flex; margin-top:10px; }
        #message-input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px 0 0 4px; }
        #send-button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 0 4px 4px 0; cursor: pointer; }
        #send-button:hover { background-color: #0056b3; }
        #status, #auth-status { padding: 10px; background-color: #eee; text-align: center; font-size: 0.9em; color: #777; margin-bottom:15px; border-radius:4px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: calc(100% - 22px); padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .auth-toggle { margin-top:15px; text-align:center; }
        .auth-toggle button { background:none; border:none; color:#007bff; cursor:pointer; text-decoration:underline; }
        #logout-button { background-color: #dc3545; color:white; padding: 8px 15px; border:none; border-radius:4px; cursor:pointer; margin-top:10px;}
    </style>
</head>
<body>
    <div id="auth-status" class="container" style="display:block;">Loading...</div>

    <div id="auth-container" class="container">
        <div id="login-form">
            <h3>Login</h3>
            <div class="form-group">
                <label for="login-identifier">Username or Email:</label>
                <input type="text" id="login-identifier" required>
            </div>
            <div class="form-group">
                <label for="login-password">Password:</label>
                <input type="password" id="login-password" required>
            </div>
            <button id="login-button">Login</button>
            <div class="auth-toggle">
                Don't have an account? <button id="show-register-form">Register here</button>
            </div>
        </div>

        <div id="register-form" style="display:none;">
            <h3>Register</h3>
            <div class="form-group">
                <label for="register-username">Username:</label>
                <input type="text" id="register-username" required>
            </div>
            <div class="form-group">
                <label for="register-email">Email:</label>
                <input type="email" id="register-email" required>
            </div>
            <div class="form-group">
                <label for="register-password">Password:</label>
                <input type="password" id="register-password" required>
            </div>
            <button id="register-button">Register</button>
            <div class="auth-toggle">
                Already have an account? <button id="show-login-form">Login here</button>
            </div>
        </div>
    </div>

    <div id="chat-app-container" class="container">
        <div id="status">Connecting...</div>
        <div id="chat-output"></div>
        <div id="input-area">
            <input type="text" id="message-input" placeholder="Type your message...">
            <button id="send-button">Send</button>
        </div>
        <button id="logout-button">Logout</button>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const chatOutput = document.getElementById('chat-output');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const statusDisplay = document.getElementById('status');
            const authStatusDisplay = document.getElementById('auth-status');

            const authContainer = document.getElementById('auth-container');
            const chatAppContainer = document.getElementById('chat-app-container');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const loginButton = document.getElementById('login-button');
            const registerButton = document.getElementById('register-button');
            const showRegisterFormButton = document.getElementById('show-register-form');
            const showLoginFormButton = document.getElementById('show-login-form');
            const logoutButton = document.getElementById('logout-button');

            let socket = null;
            let authToken = localStorage.getItem('authToken');
            let currentUsername = localStorage.getItem('username');

            function escapeHtml(unsafe) {
                return unsafe
                     .replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
            }

            function addMessageToChat(data) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message');

                let { type, username, text, message } = data; // message for generic server messages
                text = text || message; // Use 'text' or 'message' field

                if (type === 'server' || type === 'user_join' || type === 'user_leave' || type === 'auth_success' || type === 'error') {
                    messageDiv.classList.add('server-message');
                    messageDiv.textContent = escapeHtml(text || `${username} ${type === 'user_join' ? 'joined' : 'left'}`);
                } else if (type === 'message') {
                    const senderSpan = document.createElement('span');
                    senderSpan.classList.add('sender');
                    senderSpan.textContent = escapeHtml(username) + ": ";
                    messageDiv.appendChild(senderSpan);

                    const textSpan = document.createElement('span');
                    textSpan.classList.add('text');
                    textSpan.textContent = escapeHtml(text);
                    messageDiv.appendChild(textSpan);

                    if (username === currentUsername) {
                        messageDiv.classList.add('my-message');
                    } else {
                        messageDiv.classList.add('other-message');
                    }
                } else {
                    console.warn("Unknown message type received:", data);
                    messageDiv.classList.add('server-message');
                    messageDiv.textContent = escapeHtml(JSON.stringify(data)); // fallback
                }
                chatOutput.appendChild(messageDiv);
                chatOutput.scrollTop = chatOutput.scrollHeight;
            }

            function connectWebSocket(token) {
                if (!token) {
                    statusDisplay.textContent = 'Authentication token not found. Please login.';
                    authStatusDisplay.textContent = 'Authentication token not found. Please login.';
                    updateUIVisibility(false);
                    return;
                }
                statusDisplay.textContent = 'Connecting...';
                socket = new WebSocket(`ws://localhost:8080?token=${token}`);

                socket.onopen = function(e) {
                    statusDisplay.textContent = `Connected as ${currentUsername || 'user'}`;
                    console.log("WebSocket connection established!");
                    // Server will send 'auth_success' or 'error'
                };

                socket.onmessage = function(event) {
                    console.log(`Data received from server: ${event.data}`);
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'auth_success' && data.username) {
                           currentUsername = data.username; // Update username from server confirmation
                           localStorage.setItem('username', currentUsername);
                           statusDisplay.textContent = `Connected as ${currentUsername}`;
                        }
                        addMessageToChat(data);
                    } catch (err) {
                        console.error("Failed to parse message from server:", event.data, err);
                        addMessageToChat({type: 'server', message: "Received malformed data from server."});
                    }
                };

                socket.onclose = function(event) {
                    statusDisplay.textContent = 'Disconnected from chat server';
                    authStatusDisplay.textContent = 'Disconnected. Please login again.';
                    if (event.wasClean) {
                        console.log(`Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                        addMessageToChat({type: 'server', message: `Disconnected: ${event.reason || 'Connection closed cleanly'}`});
                    } else {
                        console.error('Connection died');
                        addMessageToChat({type: 'server', message: 'Connection died. Please refresh or login again.'});
                    }
                    updateUIVisibility(false);
                    socket = null; // Clear socket object
                };

                socket.onerror = function(error) {
                    statusDisplay.textContent = 'Error connecting to chat server';
                    authStatusDisplay.textContent = 'Error connecting. Please try again.';
                    console.error(`WebSocket Error: ${error.message || 'Unknown error'}`);
                    addMessageToChat({type: 'server', message: `Error: ${error.message || 'Could not connect to server.'}`});
                    updateUIVisibility(false);
                    socket = null; // Clear socket object
                };
            }

            function updateUIVisibility(isAuthenticated) {
                if (isAuthenticated) {
                    authContainer.style.display = 'none';
                    chatAppContainer.style.display = 'block';
                    authStatusDisplay.style.display = 'none';
                } else {
                    authContainer.style.display = 'block';
                    chatAppContainer.style.display = 'none';
                    loginForm.style.display = 'block';
                    registerForm.style.display = 'none';
                    authStatusDisplay.style.display = 'block'; // Show auth status when not authenticated
                }
            }

            async function handleApiRequest(url, method, body) {
                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.message || `HTTP error! status: ${response.status}`);
                    }
                    return data;
                } catch (error) {
                    console.error(`API request to ${url} failed:`, error);
                    authStatusDisplay.textContent = `Error: ${error.message}`;
                    throw error; // Re-throw to be caught by caller
                }
            }

            loginButton.onclick = async function() {
                const identifier = document.getElementById('login-identifier').value;
                const password = document.getElementById('login-password').value;
                if (!identifier || !password) {
                    authStatusDisplay.textContent = "Username/Email and password are required.";
                    return;
                }
                authStatusDisplay.textContent = "Logging in...";
                try {
                    const data = await handleApiRequest('/login.php', 'POST', { login: identifier, password: password });
                    if (data.status === 'success' && data.token) {
                        authToken = data.token;
                        currentUsername = data.user.username;
                        localStorage.setItem('authToken', authToken);
                        localStorage.setItem('username', currentUsername);
                        authStatusDisplay.textContent = "Login successful! Connecting to chat...";
                        updateUIVisibility(true);
                        connectWebSocket(authToken);
                    } else {
                        authStatusDisplay.textContent = data.message || "Login failed.";
                    }
                } catch (error) {
                    // Error already displayed by handleApiRequest
                }
            };

            registerButton.onclick = async function() {
                const username = document.getElementById('register-username').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                if (!username || !email || !password) {
                    authStatusDisplay.textContent = "All fields are required for registration.";
                    return;
                }
                authStatusDisplay.textContent = "Registering...";
                try {
                    const data = await handleApiRequest('/register.php', 'POST', { username, email, password });
                    if (data.status === 'success') {
                        authStatusDisplay.textContent = "Registration successful! Please login.";
                        showLoginFormButton.click(); // Switch to login form
                    } else {
                        authStatusDisplay.textContent = data.message || "Registration failed.";
                    }
                } catch (error) {
                     // Error already displayed by handleApiRequest
                }
            };

            showRegisterFormButton.onclick = () => {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                authStatusDisplay.textContent = "Please fill out the registration form.";
            };

            showLoginFormButton.onclick = () => {
                registerForm.style.display = 'none';
                loginForm.style.display = 'block';
                authStatusDisplay.textContent = "Please login.";
            };

            logoutButton.onclick = () => {
                localStorage.removeItem('authToken');
                localStorage.removeItem('username');
                authToken = null;
                currentUsername = null;
                if (socket) {
                    socket.close();
                }
                updateUIVisibility(false);
                authStatusDisplay.textContent = "You have been logged out.";
                chatOutput.innerHTML = ''; // Clear chat
            };

            sendButton.onclick = function() {
                const message = messageInput.value;
                if (message.trim() !== '' && socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(message); // Server expects raw message, will wrap it in JSON
                    // Optimistic display (optional, server will echo it back)
                    // addMessageToChat({ type: 'message', username: currentUsername, text: message });
                    messageInput.value = '';
                } else if (!socket || socket.readyState !== WebSocket.OPEN) {
                    addMessageToChat({type: 'server', message: "Not connected to chat. Please login or wait."});
                }
            };

            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendButton.click();
                }
            });

            // Initial UI setup
            if (authToken) {
                authStatusDisplay.textContent = "Attempting to connect to chat...";
                updateUIVisibility(true);
                connectWebSocket(authToken);
            } else {
                authStatusDisplay.textContent = "Please login or register.";
                updateUIVisibility(false);
            }
        });
    </script>
</body>
</html>
