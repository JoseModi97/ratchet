<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Chat</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; display: flex; flex-direction: column; align-items: center; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); width: 100%; max-width: 500px; margin-bottom: 20px; }
        .hidden { display: none; }
        h2 { text-align: center; color: #333; }
        label { display: block; margin-bottom: 5px; color: #555; }
        input[type="text"], input[type="email"], input[type="password"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        .error-message { color: red; text-align: center; margin-bottom: 10px; }
        .success-message { color: green; text-align: center; margin-bottom: 10px; }
        #room-list { list-style-type: none; padding: 0; }
        #room-list li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        #room-list li:hover { background-color: #f0f0f0; }
        #room-list li.private { font-style: italic; color: #555; }
        #chat-area-container { max-width: 700px; } /* Wider for chat */
        #messages { height: 400px; border: 1px solid #ddd; overflow-y: scroll; padding: 10px; margin-bottom: 10px; background-color: #fff; }
        .message { margin-bottom: 8px; padding: 5px; }
        .message .username { font-weight: bold; }
        .message.own-message { text-align: right; }
        .message.own-message .content { background-color: #dcf8c6; padding: 5px 10px; border-radius: 7px; display: inline-block; }
        .message.other-message .content { background-color: #f1f0f0; padding: 5px 10px; border-radius: 7px; display: inline-block;}
        .system-message { font-style: italic; color: #888; text-align: center; font-size: 0.9em; }
        #message-input { flex-grow: 1; margin-right: 10px; }
        #send-form { display: flex; }
    </style>
</head>
<body>

    <!-- Login View -->
    <div id="login-view" class="container">
        <h2>Login</h2>
        <form id="login-form">
            <div id="login-error" class="error-message hidden"></div>
            <label for="login-username">Username or Email:</label>
            <input type="text" id="login-username" required>
            <label for="login-password">Password:</label>
            <input type="password" id="login-password" required>
            <button type="submit">Login</button>
        </form>
        <p style="text-align: center; margin-top: 15px;">
            Don't have an account? <a href="#" id="show-register-link">Register here</a>
        </p>
    </div>

    <!-- Registration View -->
    <div id="register-view" class="container hidden">
        <h2>Register</h2>
        <form id="register-form">
            <div id="register-error" class="error-message hidden"></div>
            <div id="register-success" class="success-message hidden"></div>
            <label for="register-username">Username:</label>
            <input type="text" id="register-username" required>
            <label for="register-email">Email:</label>
            <input type="email" id="register-email" required>
            <label for="register-password">Password (min 6 chars):</label>
            <input type="password" id="register-password" required>
            <button type="submit">Register</button>
        </form>
        <p style="text-align: center; margin-top: 15px;">
            Already have an account? <a href="#" id="show-login-link">Login here</a>
        </p>
    </div>

    <!-- Main Chat Application View -->
    <div id="chat-app-view" class="container hidden">
        <h2>Chat Rooms</h2>
        <p>Welcome, <span id="welcome-username"></span>! <button id="logout-button" style="width:auto; padding: 5px 10px; font-size: 12px; float: right;">Logout</button></p>

        <div id="create-room-section">
            <h3>Create New Room</h3>
            <div id="create-room-error" class="error-message hidden"></div>
            <form id="create-room-form">
                <label for="room-name">Room Name:</label>
                <input type="text" id="room-name" required>
                <label for="is-private">Private Room:</label>
                <input type="checkbox" id="is-private" style="width: auto; margin-bottom: 15px;">
                <button type="submit">Create Room</button>
            </form>
        </div>

        <h3>Available Rooms</h3>
        <ul id="room-list">
            <!-- Rooms will be populated here -->
        </ul>
        <div id="room-list-error" class="error-message hidden"></div>

        <!-- Chat Area (Initially hidden, shown when a room is selected) -->
        <div id="chat-area-container" class="container hidden" style="margin-top: 20px;">
            <h3 id="chat-room-name"></h3>
            <button id="leave-room-button" style="width:auto; padding: 5px 10px; font-size: 12px; margin-bottom:10px;">Leave Room</button>
            <div id="messages"></div>
            <form id="send-form">
                <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off">
                <button type="submit">Send</button>
            </form>
             <div id="chat-status" style="font-size:0.8em; color:gray; margin-top:5px;"></div>
        </div>

    </div>

    <script>
        // API Base URL - dynamically determined
        const API_URL = window.location.origin + '/'; // Assumes PHP files are at the root relative to the domain

        // DOM Elements
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const chatAppView = document.getElementById('chat-app-view');

        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const createRoomForm = document.getElementById('create-room-form');

        const loginErrorDiv = document.getElementById('login-error');
        const registerErrorDiv = document.getElementById('register-error');
        const registerSuccessDiv = document.getElementById('register-success');
        const createRoomErrorDiv = document.getElementById('create-room-error');
        const roomListUl = document.getElementById('room-list');
        const roomListErrorDiv = document.getElementById('room-list-error');

        const welcomeUsernameSpan = document.getElementById('welcome-username');
        const logoutButton = document.getElementById('logout-button');

        const chatAreaContainer = document.getElementById('chat-area-container');
        const chatRoomNameH3 = document.getElementById('chat-room-name');
        const messagesDiv = document.getElementById('messages');
        const sendForm = document.getElementById('send-form');
        const messageInput = document.getElementById('message-input');
        const leaveRoomButton = document.getElementById('leave-room-button');
        const chatStatusDiv = document.getElementById('chat-status');


        // App state
        let currentUser = null; // { id, username, token }
        let currentRoomId = null;
        let websocket = null;

        // --- Utility Functions ---
        function displayError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
        }
        function clearError(element) {
            element.textContent = '';
            element.classList.add('hidden');
        }
        function displaySuccess(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
            setTimeout(() => element.classList.add('hidden'), 3000);
        }

        // --- API Call Functions ---
        async function apiCall(endpoint, method = 'GET', body = null, token = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            const config = { method, headers };
            if (body) {
                config.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(API_URL + endpoint, config);
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                return data;
            } catch (error) {
                console.error(`API call to ${endpoint} failed:`, error);
                throw error; // Re-throw to be caught by caller
            }
        }

        // --- View Switching ---
        function showView(viewId) {
            loginView.classList.add('hidden');
            registerView.classList.add('hidden');
            chatAppView.classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
        }

        // --- Authentication ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError(loginErrorDiv);
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            try {
                const data = await apiCall('login.php', 'POST', { username, password });
                currentUser = { id: data.user_id, username: data.username, token: data.token };
                localStorage.setItem('chatUser', JSON.stringify(currentUser));
                initChatApp();
            } catch (error) {
                displayError(loginErrorDiv, error.message);
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError(registerErrorDiv);
            clearError(registerSuccessDiv);
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try {
                const data = await apiCall('register.php', 'POST', { username, email, password });
                displaySuccess(registerSuccessDiv, data.message + " Please login.");
                registerForm.reset();
                setTimeout(() => showView('login-view'), 1000);
            } catch (error) {
                displayError(registerErrorDiv, error.message);
            }
        });

        logoutButton.addEventListener('click', async () => {
            const oldToken = currentUser ? currentUser.token : null;

            // Clear local state immediately for responsiveness
            currentUser = null;
            localStorage.removeItem('chatUser');
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.close(1000, "User logged out");
            }
            websocket = null; // Ensure websocket object is cleared
            chatAreaContainer.classList.add('hidden');
            currentRoomId = null;
            showView('login-view'); // Switch view immediately

            if (oldToken) {
                try {
                    // Attempt to invalidate token on the server
                    const data = await apiCall('logout.php', 'POST', {}, oldToken);
                    console.log('Logout API response:', data.message);
                } catch (error) {
                    console.error('Logout API call failed:', error.message);
                    // Client-side logout has already occurred, so this is mostly for logging
                    // or if specific UI feedback for failed server logout is needed.
                }
            }
        });

        document.getElementById('show-register-link').addEventListener('click', (e) => {
            e.preventDefault();
            showView('register-view');
        });
        document.getElementById('show-login-link').addEventListener('click', (e) => {
            e.preventDefault();
            showView('login-view');
        });

        // --- Chat App Initialization ---
        function initChatApp() {
            if (!currentUser) return;
            welcomeUsernameSpan.textContent = currentUser.username;
            showView('chat-app-view');
            fetchAndDisplayRooms();
            // Chat area remains hidden until a room is selected
            chatAreaContainer.classList.add('hidden');
        }

        // --- Room Management ---
        async function fetchAndDisplayRooms() {
            if (!currentUser) return;
            clearError(roomListErrorDiv);
            try {
                const data = await apiCall('rooms.php', 'GET', null, currentUser.token);
                roomListUl.innerHTML = ''; // Clear existing list
                if (data.rooms && data.rooms.length > 0) {
                    data.rooms.forEach(room => {
                        const li = document.createElement('li');
                        li.textContent = `${room.name} ${room.is_private ? '(Private)' : '(Public)'} - created by ${room.created_by_username || 'Unknown'}`;
                        if(room.is_private) li.classList.add('private');
                        li.dataset.roomId = room.id;
                        li.dataset.roomName = room.name;
                        li.addEventListener('click', () => selectRoom(room.id, room.name));
                        roomListUl.appendChild(li);
                    });
                } else {
                    roomListUl.innerHTML = '<li>No rooms available. Create one!</li>';
                }
            } catch (error) {
                displayError(roomListErrorDiv, "Failed to fetch rooms: " + error.message);
                 if (error.message.toLowerCase().includes("authentication") || error.message.toLowerCase().includes("token")) {
                    logoutButton.click(); // Token might be invalid, force logout
                }
            }
        }

        createRoomForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            clearError(createRoomErrorDiv);
            const name = document.getElementById('room-name').value;
            const is_private = document.getElementById('is-private').checked;
            try {
                await apiCall('rooms.php', 'POST', { name, is_private }, currentUser.token);
                createRoomForm.reset();
                fetchAndDisplayRooms(); // Refresh room list
            } catch (error) {
                displayError(createRoomErrorDiv, "Failed to create room: " + error.message);
            }
        });

        // --- Select Room and Initialize Chat (WebSocket part will be in next step) ---
        async function selectRoom(roomId, roomName) {
            if (currentRoomId === roomId && websocket && websocket.readyState === WebSocket.OPEN) {
                console.log(`Already in room ${roomId}`);
                chatAreaContainer.classList.remove('hidden'); // Ensure it's visible
                return;
            }

            // If switching rooms, leave current WebSocket room if connected
            if (websocket && websocket.readyState === WebSocket.OPEN && currentRoomId) {
                 websocket.send(JSON.stringify({ type: 'leaveRoom', roomId: currentRoomId }));
                 console.log(`Sent leave for old room ${currentRoomId}`);
            }

            currentRoomId = roomId;
            chatRoomNameH3.textContent = roomName;
            messagesDiv.innerHTML = ''; // Clear previous messages
            chatAreaContainer.classList.remove('hidden');
            chatStatusDiv.textContent = 'Connecting...';

            // Initialize WebSocket connection (Part 2 of frontend)
            // For now, just load history
            await loadMessageHistory(roomId);
            connectWebSocket(); // This function will be fully implemented in the next step
        }

        async function loadMessageHistory(roomId) {
            if(!currentUser || !roomId) return;
            try {
                const data = await apiCall(`messages.php?room_id=${roomId}`, 'GET', null, currentUser.token);
                messagesDiv.innerHTML = ''; // Clear again just in case
                data.messages.forEach(msg => displayMessage(msg, msg.sender_username, msg.content, msg.user_id === currentUser.id));
                chatStatusDiv.textContent = 'Message history loaded. Waiting for WebSocket connection.';
            } catch (error) {
                displayError(messagesDiv, `Failed to load messages: ${error.message}`);
                 chatStatusDiv.textContent = `Error loading history: ${error.message}`;
            }
        }

        function displayMessage(messageData, username, content, isOwn) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message');
            msgDiv.classList.add(isOwn ? 'own-message' : 'other-message');

            const userSpan = document.createElement('span');
            userSpan.classList.add('username');
            userSpan.textContent = isOwn ? 'Me' : username;

            const contentSpan = document.createElement('span');
            contentSpan.classList.add('content');
            contentSpan.textContent = content; // Assumes content is already escaped by server if needed, or client-side escaping for display

            if (isOwn) {
                msgDiv.appendChild(contentSpan); // Content first for own messages on right
                // msgDiv.appendChild(userSpan); // Optionally show "Me"
            } else {
                msgDiv.appendChild(userSpan);
                msgDiv.appendChild(document.createTextNode(': '));
                msgDiv.appendChild(contentSpan);
            }
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

         function displaySystemMessage(message) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('system-message');
            msgDiv.textContent = message;
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }


        // --- WebSocket Connection (Placeholder for Part 2) ---
        function connectWebSocket() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                // If already open, likely switching rooms, ensure old room leave message was sent.
                // New join will be handled by onopen after new connection or explicit send.
                websocket.close(1000, "Switching rooms");
            }

            if (!currentRoomId || !currentUser || !currentUser.token) {
                chatStatusDiv.textContent = 'Error: Cannot connect. Missing room ID or authentication token.';
                return;
            }

            let wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            // For local development with ws, we might use a specific port like 8080.
            // For wss in production, it's typically port 443, often handled by a reverse proxy without needing to specify the port in the URL.
            let wsHost = window.location.hostname;
            let wsPort = (wsProtocol === 'ws://' && wsHost === 'localhost') ? ':8080' : ''; // Keep :8080 for local ws://localhost
            // If you have a specific secure WebSocket port different from 443 that's not handled by a reverse proxy, adjust here.
            // For example, if your secure WebSocket is on localhost:8081, you might do:
            // if (wsProtocol === 'wss://' && wsHost === 'localhost') wsPort = ':8081';


            const wsUrl = `${wsProtocol}${wsHost}${wsPort}?token=${currentUser.token}`;
            console.log("Attempting WebSocket connection to:", wsUrl); // For debugging
            websocket = new WebSocket(wsUrl);
            chatStatusDiv.textContent = `Connecting to room ${chatRoomNameH3.textContent}...`;

            websocket.onopen = () => {
                console.log('WebSocket connection established.');
                chatStatusDiv.textContent = `Connected to ${chatRoomNameH3.textContent}.`;
                // Send join room message
                websocket.send(JSON.stringify({ type: 'joinRoom', roomId: currentRoomId }));
                // Message history is already loaded by selectRoom before calling connectWebSocket
            };

            websocket.onmessage = (event) => {
                console.log('WebSocket message received:', event.data);
                try {
                    const data = JSON.parse(event.data);
                    switch (data.type) {
                        case 'newMessage':
                            displayMessage(data, data.user.username, data.content, data.user.id === currentUser.id);
                            break;
                        case 'userJoined':
                            displaySystemMessage(`${data.user.username} has joined the room.`);
                            break;
                        case 'userLeft':
                            displaySystemMessage(`${data.user.username} has left the room.`);
                            break;
                        case 'auth_success': // Server confirms successful WebSocket authentication
                            console.log('WebSocket authenticated:', data.message);
                            // Could update UI or state if needed
                            break;
                        case 'joinedRoom': // Server confirms successful room join
                             console.log(`Successfully joined room ${data.roomId}: ${data.message}`);
                             chatStatusDiv.textContent = `Joined room: ${chatRoomNameH3.textContent}.`;
                             break;
                        case 'leftRoom': // Server confirms successful room leave
                            console.log(`Successfully left room ${data.roomId}: ${data.message}`);
                            // UI change handled by selectRoom or logout
                            break;
                        case 'error':
                            console.error('Server WebSocket error:', data.message);
                            displaySystemMessage(`Server error: ${data.message}`);
                            chatStatusDiv.textContent = `Error: ${data.message}`;
                            break;
                        default:
                            console.warn('Unknown WebSocket message type:', data.type);
                    }
                } catch (e) {
                    console.error('Error parsing WebSocket message or handling it:', e);
                    displaySystemMessage('Received an unreadable message from server.');
                }
            };

            websocket.onclose = (event) => {
                console.log('WebSocket connection closed:', event.reason, `Code: ${event.code}`);
                chatStatusDiv.textContent = `Disconnected. ${event.reason || 'Connection closed.'}`;
                // Optionally, implement reconnection logic here or disable chat input
                if (currentRoomId) { // Only show reconnect if a room was active
                     // For simplicity, not adding auto-reconnect now. User can re-select room.
                }
            };

            websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                chatStatusDiv.textContent = 'Connection error. Please try refreshing or re-selecting the room.';
            };
        }

        sendForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const content = messageInput.value.trim();
            if (content && websocket && websocket.readyState === WebSocket.OPEN && currentRoomId) {
                websocket.send(JSON.stringify({
                    type: 'message',
                    roomId: currentRoomId,
                    content: content
                }));
                messageInput.value = '';
                // Optimistic display is handled by server echo (newMessage includes sender)
            } else if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                chatStatusDiv.textContent = "Not connected. Cannot send message.";
            }
        });

        leaveRoomButton.addEventListener('click', () => {
            if (websocket && websocket.readyState === WebSocket.OPEN && currentRoomId) {
                websocket.send(JSON.stringify({ type: 'leaveRoom', roomId: currentRoomId }));
            }
            // Close WebSocket connection gracefully from client side as well
            if (websocket) {
                websocket.close(1000, "User left room");
            }
            chatAreaContainer.classList.add('hidden');
            currentRoomId = null;
            chatRoomNameH3.textContent = '';
            messagesDiv.innerHTML = '';
            chatStatusDiv.textContent = 'Select a room to chat.';
        });


        // --- Initial Load ---
        const storedUser = localStorage.getItem('chatUser');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            // TODO: Could add a token validation step here against the server if desired
            initChatApp();
        } else {
            showView('login-view');
        }

    </script>
</body>
</html>
